<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro v3.1</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-small { padding: 8px; font-size: 13px; margin: 4px 0; width: auto; min-width: 80px; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); position: relative; }
        .locked { border-left-color: var(--success); opacity: 0.9; }
        .check-group { background: #2c2c2e; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .row-flex { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .search-container { position: sticky; top: 70px; background: var(--bg); z-index: 90; padding-bottom: 10px; }
        h3 { margin-top: 25px; color: var(--accent); }
        h4 { margin: 15px 0 5px 0; color: #eee; border-bottom: 1px solid #333; padding-bottom: 5px; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");

const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function startApp() { let s = get("settings", { pinActive: true }); if (s.pinActive) showPin(); else menu(); }
function showPin() { app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Login</h3><input id="pinInput" type="password" placeholder="PIN" style="text-align:center;"><button onclick="checkPin()">√ñffnen</button></div>`; }
function checkPin() { if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); }
function menu() { app.innerHTML = `<button onclick="customers()">üë• Kundenverwaltung</button><button onclick="settings()">‚öôÔ∏è Einstellungen</button><button class="btn-sec" onclick="exportData()">üíæ Backup erstellen</button>`; }

// --- EINSTELLUNGEN ---
function settings() {
    let s = get("settings", { rate: 50 });
    app.innerHTML = `<h3>Einstellungen</h3><small>Stundenansatz (CHF)</small><input id="rate" type="number" value="${s.rate}">
    <button class="btn-save" onclick="saveSettings()">Speichern</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function saveSettings() { let s = get("settings", {}); s.rate = +document.getElementById("rate").value; set("settings", s); menu(); }

// --- KUNDENVERWALTUNG (MIT SUCHE) ---
function customers() {
    app.innerHTML = `
        <div class="search-container">
            <h3>Kunden & Fahrzeuge</h3>
            <input id="searchInput" type="text" placeholder="üîç Name, Marke oder Modell suchen..." onkeyup="renderCustomerList()">
        </div>
        <div id="customerList"></div>
        <hr>
        <button onclick="newCustomer()">+ Neuer Kunde</button>
        <button class="btn-sec" onclick="menu()">Zur√ºck</button>
    `;
    renderCustomerList();
}

function renderCustomerList() {
    let q = document.getElementById("searchInput") ? document.getElementById("searchInput").value.toLowerCase() : "";
    let c = get("customers", []);
    let listDiv = document.getElementById("customerList");
    let h = "";

    c.forEach((cust, ci) => {
        // Suche pr√ºft Kundenname und alle Fahrzeuge
        let vehicleString = cust.vehicles.map(v => v.brand + " " + v.model).join(" ").toLowerCase();
        if (cust.name.toLowerCase().includes(q) || vehicleString.includes(q)) {
            h += `<div class="card">
                <strong>${cust.name}</strong>
                <small>${cust.vehicles.length} Fahrzeug(e)</small>
                <div class="row-flex" style="margin-top:10px">
                    <button class="btn-small" onclick="openCustomer(${ci})">Fahrzeuge</button>
                    <button class="btn-small btn-danger" onclick="deleteCustomer(${ci})">L√∂schen</button>
                </div>
            </div>`;
        }
    });
    listDiv.innerHTML = h || "<p style='text-align:center; color:gray;'>Keine Kunden gefunden.</p>";
}

function newCustomer() { app.innerHTML = `<h3>Neuer Kunde</h3><input id="cname" placeholder="Vollst√§ndiger Name"><button class="btn-save" onclick="saveCustomer()">Anlegen</button><button class="btn-sec" onclick="customers()">Abbrechen</button>`; }
function saveCustomer() { 
    let name = document.getElementById("cname").value;
    if(!name) return;
    let c = get("customers", []); c.push({name: name, vehicles: []}); 
    set("customers", c); customers(); 
}
function deleteCustomer(ci) { if(confirm("Kunde und alle zugeh√∂rigen Daten unwiderruflich l√∂schen?")) { let c = get("customers", []); c.splice(ci,1); set("customers", c); renderCustomerList(); } }

// --- FAHRZEUGVERWALTUNG ---
function openCustomer(ci) {
    let cust = get("customers", [])[ci];
    let h = `<h3>Fahrzeuge: ${cust.name}</h3>`;
    cust.vehicles.forEach((v, vi) => {
        h += `<div class="card">
            <strong>${v.brand} ${v.model}</strong>
            <small>Kennzeichen: ${v.plate || '---'}</small>
            <div class="row-flex" style="margin-top:10px">
                <button class="btn-small" onclick="works(${ci},${vi})">Rapporte</button>
                <button class="btn-small btn-danger" onclick="deleteVehicle(${ci},${vi})">L√∂schen</button>
            </div>
        </div>`;
    });
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Neues Fahrzeug</button><button class="btn-sec" onclick="customers()">Zur√ºck zur Suche</button>`;
}

function deleteVehicle(ci, vi) { if(confirm("Fahrzeug wirklich l√∂schen?")) { let c = get("customers", []); c[ci].vehicles.splice(vi,1); set("customers", c); openCustomer(ci); } }
function newVehicle(ci) { app.innerHTML = `<h3>Neues Fahrzeug</h3><input id="vbrand" placeholder="Marke"><input id="vmodel" placeholder="Modell"><input id="vplate" placeholder="Kennzeichen"><button class="btn-save" onclick="saveVehicle(${ci})">Speichern</button><button class="btn-sec" onclick="openCustomer(${ci})">Abbrechen</button>`; }
function saveVehicle(ci) { let c = get("customers", []); c[ci].vehicles.push({ brand: document.getElementById("vbrand").value, model: document.getElementById("vmodel").value, plate: document.getElementById("vplate").value, works: [] }); set("customers", c); openCustomer(ci); }

// --- RAPPORTVERWALTUNG ---
function works(ci, vi) {
    let v = get("customers", [])[ci].vehicles[vi];
    let h = `<h3>Rapporte: ${v.brand}</h3>`;
    v.works.forEach((w, wi) => {
        h += `<div class="card ${w.closed?'locked':''}">
            <strong>${w.date}</strong> ‚Äì ${w.types?.length ? w.types.join(', ') : 'Allgemein'}
            <div class="row-flex" style="margin-top:10px">
                <button class="btn-small" onclick="openWork(${ci},${vi},${wi})">Details</button>
                ${!w.closed ? `<button class="btn-small btn-danger" onclick="deleteWork(${ci},${vi},${wi})">L√∂schen</button>` : ''}
            </div>
        </div>`;
    });
    app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`;
}

function deleteWork(ci, vi, wi) { if(confirm("Rapport l√∂schen?")) { let c = get("customers", []); c[ci].vehicles[vi].works.splice(wi,1); set("customers", c); works(ci, vi); } }

// Restliche Logik (openWork, calcTotal etc.) bleibt identisch zu deiner stabilen Version, 
// jedoch mit den korrigierten Pfaden f√ºr die L√∂schfunktionen.

function newWork(ci, vi) {
    let s = get("settings", {rate: 50}); let c = get("customers", []);
    c[ci].vehicles[vi].works.push({ 
        date: new Date().toLocaleDateString('de-CH'), km: "", types: [], fluids: {}, serviceFields: {}, 
        brakeData: {v:{t:"none",p:0,h:0}, h:{t:"none",p:0,h:0}}, bulbs: [], closed: false, rate: s.rate 
    });
    set("customers", c); openWork(ci, vi, c[ci].vehicles[vi].works.length - 1);
}

// ... (Hier w√ºrde der restliche Code f√ºr openWork folgen, wie in der letzten Nachricht definiert)

function exportData() {
    let data = JSON.stringify(get("customers", []), null, 2);
    let blob = new Blob([data], {type: "application/json"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "AutoLog_Backup_" + new Date().toLocaleDateString() + ".json";
    a.click();
}

startApp();
</script>
</body>
</html>
