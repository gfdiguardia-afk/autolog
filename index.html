<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro v3.2</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-small { padding: 10px; font-size: 13px; margin: 5px 2px; width: auto; flex: 1; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .row-flex { display: flex; gap: 8px; justify-content: space-between; }
        .search-box { position: sticky; top: 70px; background: var(--bg); z-index: 90; padding: 10px 0; border-bottom: 1px solid #333; }
        h3 { margin-top: 20px; color: var(--accent); }
        small { color: var(--text-dim); font-size: 12px; }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");

// Speicher-Funktionen
const get = (k, d) => {
    const data = localStorage.getItem(k);
    if (!data) return d;
    try { return JSON.parse(data); } catch(e) { return d; }
};
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

// Start der App
function startApp() { 
    let s = get("settings", { pinActive: true }); 
    if (s.pinActive) showPin(); else menu(); 
}

function showPin() { 
    app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Werkstatt-Login</h3>
    <input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px">
    <button onclick="checkPin()">√ñffnen</button></div>`; 
}

function checkPin() { 
    if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); 
}

function menu() { 
    app.innerHTML = `
    <button onclick="customers()">üë• Kundenverwaltung</button>
    <button onclick="settings()">‚öôÔ∏è Einstellungen</button>
    <button class="btn-sec" onclick="exportData()">üíæ Daten sichern</button>`; 
}

// --- KUNDENVERWALTUNG MIT FUNKTIONIERENDER SUCHE ---
function customers() {
    app.innerHTML = `
        <div class="search-box">
            <input id="searchInput" type="text" placeholder="üîç Name oder Fahrzeug suchen..." oninput="renderCustomerList()">
        </div>
        <div id="customerList"></div>
        <button onclick="newCustomer()">+ Neuer Kunde</button>
        <button class="btn-sec" onclick="menu()">Hauptmen√º</button>
    `;
    renderCustomerList(); // Zeigt sofort alle Kunden an
}

function renderCustomerList() {
    const q = document.getElementById("searchInput") ? document.getElementById("searchInput").value.toLowerCase() : "";
    const c = get("customers", []);
    const listDiv = document.getElementById("customerList");
    let h = "";

    if (c.length === 0) {
        listDiv.innerHTML = "<p style='text-align:center; padding:20px; color:gray;'>Keine Kunden angelegt.</p>";
        return;
    }

    c.forEach((cust, ci) => {
        const vehicleMatch = cust.vehicles ? cust.vehicles.some(v => (v.brand + " " + v.model).toLowerCase().includes(q)) : false;
        const nameMatch = cust.name.toLowerCase().includes(q);

        if (nameMatch || vehicleMatch || q === "") {
            h += `
            <div class="card">
                <strong>${cust.name}</strong><br>
                <small>${cust.vehicles ? cust.vehicles.length : 0} Fahrzeuge hinterlegt</small>
                <div class="row-flex">
                    <button class="btn-small" onclick="openCustomer(${ci})">√ñffnen</button>
                    <button class="btn-small btn-danger" onclick="deleteCustomer(${ci})">L√∂schen</button>
                </div>
            </div>`;
        }
    });
    listDiv.innerHTML = h;
}

function newCustomer() { 
    app.innerHTML = `
    <h3>Neuer Kunde</h3>
    <input id="cname" placeholder="Name des Kunden">
    <button class="btn-save" onclick="saveCustomer()">Speichern</button>
    <button class="btn-sec" onclick="customers()">Abbrechen</button>`; 
}

function saveCustomer() { 
    const name = document.getElementById("cname").value;
    if(!name) { alert("Bitte Namen eingeben"); return; }
    let c = get("customers", []); 
    c.push({name: name, vehicles: []}); 
    set("customers", c); 
    customers(); 
}

function deleteCustomer(ci) { 
    if(confirm("Diesen Kunden wirklich l√∂schen?")) { 
        let c = get("customers", []); 
        c.splice(ci,1); 
        set("customers", c); 
        renderCustomerList(); 
    } 
}

// --- FAHRZEUG-LOGIK ---
function openCustomer(ci) {
    const cust = get("customers", [])[ci];
    let h = `<h3>Fahrzeuge von ${cust.name}</h3>`;
    
    if (cust.vehicles && cust.vehicles.length > 0) {
        cust.vehicles.forEach((v, vi) => {
            h += `
            <div class="card">
                <strong>${v.brand} ${v.model}</strong><br>
                <small>Kennzeichen: ${v.plate || 'keines'}</small>
                <div class="row-flex">
                    <button class="btn-small" onclick="works(${ci},${vi})">Rapporte</button>
                    <button class="btn-small btn-danger" onclick="deleteVehicle(${ci},${vi})">L√∂schen</button>
                </div>
            </div>`;
        });
    } else {
        h += "<p style='color:gray;'>Noch kein Fahrzeug erfasst.</p>";
    }
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug hinzuf√ºgen</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`;
}

function newVehicle(ci) {
    app.innerHTML = `
    <h3>Fahrzeug hinzuf√ºgen</h3>
    <input id="vbrand" placeholder="Marke (z.B. VW)">
    <input id="vmodel" placeholder="Modell (z.B. Golf)">
    <input id="vplate" placeholder="Kennzeichen">
    <button class="btn-save" onclick="saveVehicle(${ci})">Speichern</button>
    <button class="btn-sec" onclick="openCustomer(${ci})">Abbrechen</button>`;
}

function saveVehicle(ci) {
    let c = get("customers", []);
    const brand = document.getElementById("vbrand").value;
    if(!brand) return;
    c[ci].vehicles.push({ 
        brand: brand, 
        model: document.getElementById("vmodel").value, 
        plate: document.getElementById("vplate").value, 
        works: [] 
    });
    set("customers", c);
    openCustomer(ci);
}

function deleteVehicle(ci, vi) {
    if(confirm("Fahrzeug l√∂schen?")) {
        let c = get("customers", []);
        c[ci].vehicles.splice(vi, 1);
        set("customers", c);
        openCustomer(ci);
    }
}

// --- RAPPORT-LOGIK (Platzhalter f√ºr deine restlichen Funktionen) ---
function works(ci, vi) {
    const v = get("customers", [])[ci].vehicles[vi];
    app.innerHTML = `<h3>Rapporte: ${v.brand}</h3><p>Hier kommen deine bestehenden Rapport-Funktionen hin...</p><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`;
}

function settings() { app.innerHTML = `<h3>Einstellungen</h3><button class="btn-sec" onclick="menu()">Zur√ºck</button>`; }
function exportData() { alert("Daten als JSON gesichert (Simulation)"); }

startApp();
</script>
</body>
</html>
