<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro v3.9</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-small { padding: 10px; font-size: 13px; margin: 5px 2px; width: auto; flex: 1; }
        .btn-minus { background: var(--danger); width: 40px; flex: none; padding: 10px 0; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .locked { border-left-color: var(--success); opacity: 0.8; }
        .row-flex { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .check-group { background: #2c2c2e; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 12px; margin: 10px 0; cursor: pointer; }
        .check-item input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        .search-box { position: sticky; top: 70px; background: var(--bg); z-index: 90; padding: 10px 0; border-bottom: 1px solid #333; }
        h3 { margin-top: 20px; color: var(--accent); }
        h4 { margin: 15px 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 5px; color: #eee; }
        small { color: var(--text-dim); font-size: 12px; display: block; }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");
const LABELS = { oil: "Motor√∂l", washer: "Wischwasser", coolant: "K√ºhlmittel", brake: "Bremsfl√ºssigkeit", gear: "Getriebe√∂l", servo: "Servolenkungs√∂l" };

const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function startApp() { let s = get("settings", { pinActive: true }); if (s.pinActive) showPin(); else menu(); }
function showPin() { app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Login</h3><input id="pinInput" type="password" placeholder="PIN" style="text-align:center;"><button onclick="checkPin()">√ñffnen</button></div>`; }
function checkPin() { if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); }
function menu() { app.innerHTML = `<button onclick="customers()">üë• Kundenverwaltung</button><button onclick="settings()">‚öôÔ∏è Einstellungen</button><button class="btn-sec" onclick="exportData()">üíæ Backup</button>`; }

function settings() {
    let s = get("settings", { rate: 50, cleanPrice: 20 });
    app.innerHTML = `<h3>Einstellungen</h3><small>Stundenansatz (CHF)</small><input id="rate" type="number" value="${s.rate}">
    <small>Reinigung (CHF)</small><input id="cleanPrice" type="number" value="${s.cleanPrice}">
    <button class="btn-save" onclick="saveSettings()">Speichern</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function saveSettings() { let s = get("settings", {}); s.rate = +document.getElementById("rate").value; s.cleanPrice = +document.getElementById("cleanPrice").value; set("settings", s); menu(); }

function customers() {
    app.innerHTML = `<div class="search-box"><input id="searchInput" type="text" placeholder="üîç Suche..." oninput="renderCustomerList()"></div>
    <div id="customerList"></div><button onclick="newCustomer()">+ Neuer Kunde</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
    renderCustomerList();
}

function renderCustomerList() {
    const q = document.getElementById("searchInput") ? document.getElementById("searchInput").value.toLowerCase() : "";
    const c = get("customers", []);
    let h = "";
    c.forEach((cust, ci) => {
        const vMatch = cust.vehicles.some(v => (v.brand + " " + v.model).toLowerCase().includes(q));
        if (cust.name.toLowerCase().includes(q) || vMatch || q === "") {
            h += `<div class="card"><strong>${cust.name}</strong><div class="row-flex"><button class="btn-small" onclick="openCustomer(${ci})">Anzeigen</button><button class="btn-small btn-danger" onclick="deleteCustomer(${ci})">L√∂schen</button></div></div>`;
        }
    });
    document.getElementById("customerList").innerHTML = h || "<p style='color:gray'>Keine Treffer.</p>";
}

function newCustomer() { app.innerHTML = `<h3>Neuer Kunde</h3><input id="cname" placeholder="Name"><button class="btn-save" onclick="saveCustomer()">Anlegen</button>`; }
function saveCustomer() { let c = get("customers", []); c.push({name: document.getElementById("cname").value, vehicles: []}); set("customers", c); customers(); }
function deleteCustomer(ci) { if(confirm("L√∂schen?")) { let c = get("customers", []); c.splice(ci,1); set("customers", c); renderCustomerList(); } }

function openCustomer(ci) {
    const cust = get("customers", [])[ci];
    let h = `<h3>Fahrzeuge von ${cust.name}</h3>`;
    cust.vehicles.forEach((v, vi) => h += `<div class="card"><strong>${v.brand} ${v.model}</strong><br><small>${v.plate}</small><div class="row-flex"><button class="btn-small" onclick="works(${ci},${vi})">Rapporte</button><button class="btn-small btn-danger" onclick="deleteVehicle(${ci},${vi})">L√∂schen</button></div></div>`);
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`;
}

function newVehicle(ci) { app.innerHTML = `<h3>Neues Fahrzeug</h3><input id="vbrand" placeholder="Marke"><input id="vmodel" placeholder="Modell"><input id="vplate" placeholder="Kennzeichen"><button class="btn-save" onclick="saveVehicle(${ci})">Speichern</button>`; }
function saveVehicle(ci) { let c = get("customers", []); c[ci].vehicles.push({ brand: document.getElementById("vbrand").value, model: document.getElementById("vmodel").value, plate: document.getElementById("vplate").value, works: [] }); set("customers", c); openCustomer(ci); }
function deleteVehicle(ci, vi) { if(confirm("L√∂schen?")) { let c = get("customers", []); c[ci].vehicles.splice(vi,1); set("customers", c); openCustomer(ci); } }

function works(ci, vi) {
    const v = get("customers", [])[ci].vehicles[vi];
    let h = `<h3>Rapporte: ${v.brand}</h3>`;
    v.works.forEach((w, wi) => h += `<div class="card ${w.closed?'locked':''}"><strong>${w.date}</strong> - ${w.types?.join(', ') || 'Rapport'}<div class="row-flex"><button class="btn-small" onclick="openWork(${ci},${vi},${wi})">Details</button>${!w.closed?`<button class="btn-small btn-danger" onclick="deleteWork(${ci},${vi},${wi})">L√∂schen</button>`:''}</div></div>`);
    app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`;
}

function deleteWork(ci, vi, wi) { if(confirm("L√∂schen?")) { let c = get("customers", []); c[ci].vehicles[vi].works.splice(wi,1); set("customers", c); works(ci, vi); } }

function newWork(ci, vi) {
    let s = get("settings", {rate: 50, cleanPrice: 20}); let c = get("customers", []);
    c[ci].vehicles[vi].works.push({ 
        date: new Date().toLocaleDateString('de-CH'), km: "", types: [], fluids: {}, 
        serviceFields: { inspection:0, oilFilter:0, pollenFilter:0, airFilter:0, fuelFilter:0, plugs:0, plugsT:0, belt:0, beltT:0, pump:0, ribbed:false, ribbedM:0 },
        mfkPoints: {}, mfkPrepTime: 0, brakeData: {v:{t:"none",p:null,h:null}, h:{t:"none",p:null,h:null}}, 
        bulbs: [], partsList: [], laborList: [], closed: false, rate: s.rate, prices: { oil:15, coolant:10, brake:20, gear:25, servo:18, washer:2, cleanPrice: s.cleanPrice } 
    });
    set("customers", c); openWork(ci, vi, c[ci].vehicles[vi].works.length - 1);
}

function openWork(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; let dis = w.closed ? "disabled" : "";
    app.innerHTML = `<h3>Rapport ‚Äì ${w.date}</h3>
    <div class="check-group">
        ${["Service","MFK","Fl√ºssigkeiten","Bremsen","Beleuchtung","Reparatur"].map(t => `<label class="check-item"><input ${dis} type="checkbox" onchange="toggleType('${t}',${ci},${vi},${wi})" ${w.types.includes(t)?'checked':''}> ${t}</label>`).join('')}
    </div>
    <small>KM-Stand *</small><input ${dis} id="wkm" type="number" value="${w.km}" oninput="updateW(${ci},${vi},${wi})">
    <div id="dynamicFields"></div>
    <hr><div style="font-size:22px; font-weight:bold; color:var(--success)" id="liveTotal">Total: CHF ${calcTotal(w)}</div>
    ${!w.closed ? `<button class="btn-save" onclick="saveW(${ci},${vi},${wi}, false)">üíæ Speichern</button><button class="btn-danger" onclick="saveW(${ci},${vi},${wi}, true)">‚úÖ Abschliessen</button>` : ''}
    <button class="btn-sec" onclick="works(${ci},${vi})">Zur√ºck</button>`;
    renderDynamic(ci, vi, wi);
}

function renderDynamic(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; let dis = w.closed ? "disabled" : ""; let dHtml = "";
    
    // --- SERVICE BLOCK (Deine Vorlage) ---
    if(w.types.includes("Service")) {
        dHtml += `<h4>Service Details</h4>
        <small>Jahres Inspektion (Std)</small><input ${dis} type="number" step="0.1" id="s_insp" value="${w.serviceFields.inspection}" oninput="updateW(${ci},${vi},${wi})">
        <small>√ñlfilter (Material)</small><input ${dis} type="number" id="s_oilf" value="${w.serviceFields.oilFilter}" oninput="updateW(${ci},${vi},${wi})">
        <small>Pollenfilter (Material)</small><input ${dis} type="number" id="s_poll" value="${w.serviceFields.pollenFilter}" oninput="updateW(${ci},${vi},${wi})">
        <small>Luftfilter (Material)</small><input ${dis} type="number" id="s_air" value="${w.serviceFields.airFilter}" oninput="updateW(${ci},${vi},${wi})">
        <small>Kraftstofffilter (Material)</small><input ${dis} type="number" id="s_fuel" value="${w.serviceFields.fuelFilter}" oninput="updateW(${ci},${vi},${wi})">
        <hr>
        <small>Z√ºndkerzen (Material)</small><input ${dis} type="number" id="s_plug" value="${w.serviceFields.plugs}" oninput="updateW(${ci},${vi},${wi})">
        <small>Z√ºndkerzen ersetzen (Std)</small><input ${dis} type="number" step="0.1" id="s_plugT" value="${w.serviceFields.plugsT}" oninput="updateW(${ci},${vi},${wi})">
        <hr>
        <small>Zahnriemensatz (Material)</small><input ${dis} type="number" id="s_belt" value="${w.serviceFields.belt}" oninput="updateW(${ci},${vi},${wi})">
        <small>Zahnriemen ersetzen (Std)</small><input ${dis} type="number" step="0.1" id="s_beltT" value="${w.serviceFields.beltT}" oninput="updateW(${ci},${vi},${wi})">
        <hr>
        <small>Wasserpumpe (Material)</small><input ${dis} type="number" id="s_pump" value="${w.serviceFields.pump}" oninput="updateW(${ci},${vi},${wi})">
        <small>Keilrippenriemen (Material)</small><input ${dis} type="number" id="s_ribM" value="${w.serviceFields.ribbedM}" oninput="updateW(${ci},${vi},${wi})">
        <label class="check-item"><input ${dis} type="checkbox" id="s_rib" ${w.serviceFields.ribbed?'checked':''} onchange="updateW(${ci},${vi},${wi})"> <span>Keilrippenriemen i.O.</span></label>`;
    }
    // --- MFK BLOCK (Deine Vorlage) ---
    if(w.types.includes("MFK")) {
        dHtml += `<h4>MFK Checkliste</h4><small>MFK richten (Std)</small><input ${dis} type="number" step="0.1" id="m_prep" value="${w.mfkPrepTime}" oninput="updateW(${ci},${vi},${wi})">
        <div class="check-group">${["Licht gepr√ºft","Licht eingestellt","Bremsen gepr√ºft","Auspuff gepr√ºft","Motor & Karosserie gereinigt"].map(p => `<label class="check-item"><input ${dis} type="checkbox" onchange="toggleMfk('${p}',${ci},${vi},${wi})" ${w.mfkPoints[p]?'checked':''}> <span>${p}</span></label>`).join('')}</div>`;
    }
    // --- BREMSEN & BELEUCHTUNG & REPARATUR ---
    if(w.types.includes("Bremsen")) {
        dHtml += `<h4>Bremsen</h4><small>Vorne</small><select ${dis} onchange="updateBrake(${ci},${vi},${wi},'v','t',this.value)"><option value="none">Keine</option><option value="pads" ${w.brakeData.v.t=='pads'?'selected':''}>Kl√∂tze</option><option value="disks" ${w.brakeData.v.t=='disks'?'selected':''}>Kl√∂tze & Scheiben</option></select>
        <div class="row-flex"><input ${dis} type="number" placeholder="CHF" value="${w.brakeData.v.p || ''}" oninput="updateBrake(${ci},${vi},${wi},'v','p',this.value)"><input ${dis} type="number" step="0.1" placeholder="Std" value="${w.brakeData.v.h || ''}" oninput="updateBrake(${ci},${vi},${wi},'v','h',this.value)"></div>
        <small>Hinten</small><select ${dis} onchange="updateBrake(${ci},${vi},${wi},'h','t',this.value)"><option value="none">Keine</option><option value="pads" ${w.brakeData.h.t=='pads'?'selected':''}>Kl√∂tze</option><option value="disks" ${w.brakeData.h.t=='disks'?'selected':''}>Kl√∂tze & Scheiben</option></select>
        <div class="row-flex"><input ${dis} type="number" placeholder="CHF" value="${w.brakeData.h.p || ''}" oninput="updateBrake(${ci},${vi},${wi},'h','p',this.value)"><input ${dis} type="number" step="0.1" placeholder="Std" value="${w.brakeData.h.h || ''}" oninput="updateBrake(${ci},${vi},${wi},'h','h',this.value)"></div>`;
    }
    if(w.types.includes("Beleuchtung")) {
        dHtml += `<h4>Beleuchtung</h4><div id="bulbList">` + w.bulbs.map((b, i) => `<div class="row-flex"><input ${dis} placeholder="Birne" value="${b.t}" oninput="updateList(${ci},${vi},${wi},'bulbs',${i},'t',this.value)"><input ${dis} type="number" placeholder="CHF" value="${b.p || ''}" oninput="updateList(${ci},${vi},${wi},'bulbs',${i},'p',this.value)"><input ${dis} type="number" step="0.1" placeholder="Std" value="${b.h || ''}" oninput="updateList(${ci},${vi},${wi},'bulbs',${i},'h',this.value)">${!dis?`<button class="btn-small btn-minus" onclick="removeRow(${ci},${vi},${wi},'bulbs',${i})">-</button>`:''}</div>`).join('') + `</div><button ${dis} class="btn-sec btn-small" onclick="addRow(${ci},${vi},${wi},'bulbs',{t:'',p:null,h:null})">+ Birne</button>`;
    }
    if(w.types.includes("Reparatur")) {
        dHtml += `<h4>Reparatur (Teile)</h4>` + w.partsList.map((p, i) => `<div class="row-flex"><input ${dis} placeholder="Teil" value="${p.t}" oninput="updateList(${ci},${vi},${wi},'partsList',${i},'t',this.value)"><input ${dis} type="number" placeholder="CHF" value="${p.p}" oninput="updateList(${ci},${vi},${wi},'partsList',${i},'p',this.value)">${!dis?`<button class="btn-small btn-minus" onclick="removeRow(${ci},${vi},${wi},'partsList',${i})">-</button>`:''}</div>`).join('') + `<button ${dis} class="btn-sec btn-small" onclick="addRow(${ci},${vi},${wi},'partsList',{t:'',p:null})">+ Teil</button>`;
        dHtml += `<h4>Reparatur (Arbeit)</h4>` + w.laborList.map((l, i) => `<div class="row-flex"><input ${dis} placeholder="Arbeit" value="${l.t}" oninput="updateList(${ci},${vi},${wi},'laborList',${i},'t',this.value)"><input ${dis} type="number" step="0.1" placeholder="Std" value="${l.h}" oninput="updateList(${ci},${vi},${wi},'laborList',${i},'h',this.value)">${!dis?`<button class="btn-small btn-minus" onclick="removeRow(${ci},${vi},${wi},'laborList',${i})">-</button>`:''}</div>`).join('') + `<button ${dis} class="btn-sec btn-small" onclick="addRow(${ci},${vi},${wi},'laborList',{t:'',h:null})">+ Arbeit</button>`;
    }
    if(w.types.includes("Fl√ºssigkeiten")) {
        dHtml += `<h4>Fl√ºssigkeiten</h4>` + Object.keys(LABELS).map(k => `<small>${LABELS[k]}</small><input ${dis} type="number" step="0.1" value="${w.fluids[k] || ''}" oninput="updateFluid(${ci},${vi},${wi},'${k}',this.value)">`).join('');
    }
    document.getElementById("dynamicFields").innerHTML = dHtml;
}

function toggleType(t,ci,vi,wi) { let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; if(w.types.includes(t)) w.types = w.types.filter(x=>x!==t); else w.types.push(t); set("customers", c); renderDynamic(ci,vi,wi); updateW(ci,vi,wi); }
function toggleMfk(p,ci,vi,wi) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].mfkPoints[p] = !c[ci].vehicles[vi].works[wi].mfkPoints[p]; set("customers", c); renderDynamic(ci,vi,wi); updateW(ci,vi,wi); }
function addRow(ci,vi,wi,list,obj) { let c = get("customers", []); c[ci].vehicles[vi].works[wi][list].push(obj); set("customers", c); renderDynamic(ci,vi,wi); }
function removeRow(ci,vi,wi,list,i) { let c = get("customers", []); c[ci].vehicles[vi].works[wi][list].splice(i,1); set("customers", c); renderDynamic(ci,vi,wi); updateW(ci,vi,wi); }
function updateList(ci,vi,wi,list,i,k,v) { let c = get("customers", []); c[ci].vehicles[vi].works[wi][list][i][k] = (k==='t')?v:+v; set("customers", c); updateW(ci,vi,wi); }
function updateFluid(ci,vi,wi,k,v) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].fluids[k] = +v; set("customers", c); updateW(ci,vi,wi); }
function updateBrake(ci,vi,wi,s,k,v) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].brakeData[s][k] = (k==='t')?v:+v; set("customers", c); updateW(ci,vi,wi); }

function updateW(ci,vi,wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    w.km = document.getElementById("wkm").value;
    if(w.types.includes("Service")) {
        w.serviceFields = {
            inspection: +document.getElementById("s_insp").value, oilFilter: +document.getElementById("s_oilf").value, pollenFilter: +document.getElementById("s_poll").value,
            airFilter: +document.getElementById("s_air").value, fuelFilter: +document.getElementById("s_fuel").value, plugs: +document.getElementById("s_plug").value,
            plugsT: +document.getElementById("s_plugT").value, belt: +document.getElementById("s_belt").value, beltT: +document.getElementById("s_beltT").value,
            pump: +document.getElementById("s_pump").value, ribbed: document.getElementById("s_rib").checked, ribbedM: +document.getElementById("s_ribM").value
        };
    }
    if(w.types.includes("MFK")) w.mfkPrepTime = +document.getElementById("m_prep").value;
    document.getElementById("liveTotal").innerText = "Total: CHF " + calcTotal(w);
    set("customers", c);
}

function calcTotal(w) {
    let total = 0;
    Object.keys(LABELS).forEach(k => total += (parseFloat(w.fluids[k])||0) * (w.prices[k]||0));
    w.partsList.forEach(p => total += (parseFloat(p.p)||0));
    w.laborList.forEach(l => total += (parseFloat(l.h)||0) * w.rate);
    total += (parseFloat(w.brakeData.v.p)||0) + (parseFloat(w.brakeData.h.p)||0) + (((parseFloat(w.brakeData.v.h)||0) + (parseFloat(w.brakeData.h.h)||0)) * w.rate);
    w.bulbs.forEach(b => total += (parseFloat(b.p)||0) + ((parseFloat(b.h)||0) * w.rate));
    if(w.types.includes("Service")) {
        total += (w.serviceFields.inspection * w.rate) + (w.serviceFields.oilFilter) + (w.serviceFields.pollenFilter) + (w.serviceFields.airFilter) + (w.serviceFields.fuelFilter) + (w.serviceFields.plugs) + (w.serviceFields.plugsT * w.rate) + (w.serviceFields.belt) + (w.serviceFields.beltT * w.rate) + (w.serviceFields.pump) + (w.serviceFields.ribbedM);
    }
    if(w.types.includes("MFK")) {
        total += (w.mfkPrepTime * w.rate);
        if(w.mfkPoints["Motor & Karosserie gereinigt"]) total += (w.prices.cleanPrice || 0);
    }
    return total.toFixed(2);
}

function saveW(ci, vi, wi, close) {
    if(!document.getElementById("wkm").value) { alert("KM-Stand fehlt!"); return; }
    let c = get("customers", []); 
    if(close) { if(confirm("Abschliessen?")) { c[ci].vehicles[vi].works[wi].closed = true; set("customers", c); works(ci, vi); } }
    else { set("customers", c); alert("Gespeichert!"); works(ci, vi); }
}

function exportData() { let a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([localStorage.getItem("customers")], {type: "application/json"})); a.download = "autolog_backup.json"; a.click(); }
startApp();
</script>
</body>
</html>
