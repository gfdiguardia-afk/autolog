<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoLog</title>
<style>
body{margin:0;font-family:Arial;background:#111;color:#eee}
header{background:#000;padding:15px;text-align:center;font-size:20px}
.container{padding:15px}
button,input,select,textarea{
 width:100%;margin:6px 0;padding:12px;
 background:#1f1f1f;color:#fff;border:1px solid #444;border-radius:6px
}
textarea{min-height:60px}
.card{background:#1c1c1c;padding:12px;margin:10px 0;border-radius:8px}
small{color:#aaa}
.locked{opacity:.6}
hr{border:0;border-top:1px solid #333;margin:15px 0}
.danger{background:#400}
</style>
</head>
<body>

<header>AutoLog</header>
<div class="container" id="app"></div>

<script>
const app=document.getElementById("app");
const get=(k,d)=>JSON.parse(localStorage.getItem(k))||d;
const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* CHECKLISTEN */
const CHECKLISTS={
 Service:[
  "Ölwechsel","Ölfilter","Luftfilter","Pollenfilter",
  "Bremsen vorne","Bremsen hinten","Zahnriemen"
 ],
 MFK:[
  "Licht geprüft","Leuchtweitenregulierung geprüft","Bremsen geprüft",
  "Horn geprüft","Lenkradsperre geprüft","Scheibenwischer geprüft",
  "Auspuff geprüft","Reifen geprüft"
 ],
 Reifenwechsel:[
  "Sommer-/Winterreifen montiert","Reifendruck geprüft","Radschrauben nachgezogen"
 ],
 Reparatur:["Arbeiten durchgeführt"]
};

/* MENU */
function menu(){
 app.innerHTML=`
 <button onclick="customers()">Kunden</button>
 <button onclick="settings()">Einstellungen</button>`;
}

/* SETTINGS */
function settings(){
 let s=get("settings",{rate:50,oil:15,coolant:10,brake:20,gear:25,servo:18,washer:2});
 app.innerHTML=`
 <h3>Grundeinstellungen</h3>

 <b>Stundenansatz</b>
 <small>CHF pro Stunde</small>
 <input id="rate" value="${s.rate}">

 <hr>

 ${price("Motoröl","oil",s)}
 ${price("Kühlmittel","coolant",s)}
 ${price("Bremsflüssigkeit","brake",s)}
 ${price("Getriebeöl","gear",s)}
 ${price("Servolenkungsöl","servo",s)}
 ${price("Scheibenwischwasser","washer",s)}

 <button onclick="saveSettings()">Speichern</button>
 <button onclick="menu()">Zurück</button>`;
}
const price=(l,k,s)=>`<b>${l}</b><small>Preis pro Liter CHF</small><input id="${k}" value="${s[k]}">`;
function saveSettings(){
 set("settings",{rate:+rate.value,oil:+oil.value,coolant:+coolant.value,brake:+brake.value,gear:+gear.value,servo:+servo.value,washer:+washer.value});
 menu();
}

/* CUSTOMERS */
function customers(){
 let c=get("customers",[]);
 let h="<h3>Kunden</h3>";
 c.forEach((x,i)=>h+=`
 <div class="card">
  <b>${x.name}</b>
  <button onclick="openCustomer(${i})">Öffnen</button>
 </div>`);
 app.innerHTML=h+`
 <button onclick="newCustomer()">Neuer Kunde</button>
 <button onclick="menu()">Zurück</button>`;
}

function newCustomer(){
 app.innerHTML=`
 <h3>Neuer Kunde</h3>
 <input id="name" placeholder="Name">
 <button onclick="saveCustomer()">Speichern</button>`;
}
function saveCustomer(){
 let n=name.value.trim();
 if(!n){alert("Bitte Name eingeben");return;}
 let c=get("customers",[]);
 c.push({name:n,vehicles:[]});
 set("customers",c);customers();
}

/* VEHICLES */
function openCustomer(ci){
 let c=get("customers",[]);
 let cust=c[ci];
 let h=`<h3>${cust.name}</h3>`;
 cust.vehicles.forEach((v,vi)=>h+=`
 <div class="card">
  ${v.brand} ${v.model}<br><small>${v.plate}</small>
  <button onclick="works(${ci},${vi})">Rapporte</button>
 </div>`);
 app.innerHTML=h+`
 <button onclick="newVehicle(${ci})">Fahrzeug hinzufügen</button>
 <button class="danger" onclick="deleteCustomer(${ci})">Kunde löschen</button>
 <button onclick="customers()">Zurück</button>`;
}

function deleteCustomer(ci){
 if(confirm("Kunde inkl. aller Daten löschen?")){
  let c=get("customers",[]);
  c.splice(ci,1);set("customers",c);customers();
 }
}

function newVehicle(ci){
 app.innerHTML=`
 <h3>Fahrzeug</h3>
 <input id="brand" placeholder="Marke">
 <input id="model" placeholder="Modell">
 <input id="plate" placeholder="Kennzeichen">
 <button onclick="saveVehicle(${ci})">Speichern</button>`;
}
function saveVehicle(ci){
 let c=get("customers",[]);
 c[ci].vehicles.push({brand:brand.value,model:model.value,plate:plate.value,works:[]});
 set("customers",c);openCustomer(ci);
}

/* WORKS */
function works(ci,vi){
 let v=get("customers",[])[ci].vehicles[vi];
 let h="<h3>Rapporte</h3>";
 v.works.forEach((w,wi)=>h+=`
 <div class="card ${w.closed?'locked':''}">
  ${w.date} – ${w.type}<br>
  <small>${w.closed?'Abgeschlossen':'Entwurf'}</small>
  <button onclick="openWork(${ci},${vi},${wi})">Öffnen</button>
 </div>`);
 app.innerHTML=h+`
 <button onclick="newWork(${ci},${vi})">Neuer Rapport</button>
 <button onclick="openCustomer(${ci})">Zurück</button>`;
}

function newWork(ci,vi){
 let s=get("settings",{});
 let w={
  date:new Date().toLocaleDateString(),
  km:"",type:"Service",
  check:{},fluids:{},note:"",
  time:0,parts:0,
  rate:s.rate,prices:{...s},
  closed:false,closedAt:null
 };
 let c=get("customers",[]);
 c[ci].vehicles[vi].works.push(w);
 set("customers",c);
 openWork(ci,vi,c[ci].vehicles[vi].works.length-1);
}

/* OPEN WORK */
function openWork(ci,vi,wi){
 let c=get("customers",[]);
 let w=c[ci].vehicles[vi].works[wi];
 let dis=w.closed?"disabled":"";
 app.innerHTML=`
 <h3>${w.type} – ${w.date}</h3>
 ${w.closed?`<small style="color:#f66">Rapport abgeschlossen am ${w.closedAt}</small>`:""}

 <small>Kilometerstand</small>
 <input ${dis} value="${w.km}" oninput="w.km=this.value">

 <small>Arbeitsart</small>
 <select ${dis} onchange="loadChecklist(this.value,w)">
  ${Object.keys(CHECKLISTS).map(t=>`<option ${w.type==t?"selected":""}>${t}</option>`).join("")}
 </select>

 <h4>Checkliste</h4>
 <div id="check"></div>

 <h4>Flüssigkeiten (Liter)</h4>
 ${fluid("Motoröl","oil",w)}
 ${fluid("Kühlmittel","coolant",w)}
 ${fluid("Bremsflüssigkeit","brake",w)}
 ${fluid("Getriebeöl","gear",w)}
 ${fluid("Servolenkungsöl","servo",w)}
 ${fluid("Scheibenwischwasser","washer",w)}

 <h4>Bemerkungen</h4>
 <textarea ${dis} oninput="w.note=this.value">${w.note}</textarea>

 <h4>Arbeitszeit</h4>
 <small>Stunden</small>
 <input ${dis} value="${w.time}" oninput="w.time=+this.value||0;updateTotal(w)">
 <small>Teilekosten CHF</small>
 <input ${dis} value="${w.parts}" oninput="w.parts=+this.value||0;updateTotal(w)">

 <hr>
 <b id="total">Total CHF: ${calc(w)}</b>

 ${!w.closed?`
 <button onclick="closeWork(${ci},${vi},${wi})">Rapport abschliessen</button>
 <button class="danger" onclick="deleteWork(${ci},${vi},${wi})">Rapport löschen</button>`:""}

 <button onclick="saveWork(${ci},${vi},${wi})">Speichern</button>
 <button onclick="works(${ci},${vi})">Zurück</button>`;
 loadChecklist(w.type,w);
}

/* CHECKLIST */
function loadChecklist(type,w){
 w.type=type;
 if(!w.check) w.check={};
 let d=document.getElementById("check");
 d.innerHTML="";
 (CHECKLISTS[type]||[]).forEach(t=>{
  if(!w.check[t]) w.check[t]={done:false,note:""};
  d.innerHTML+=`
   <div class="card">
    <label>
     <input type="checkbox" ${w.check[t].done?"checked":""}
      ${w.closed?"disabled":""}
      onchange="w.check['${t}'].done=this.checked">
     ${t}
    </label>
    <textarea ${w.closed?"disabled":""}
     placeholder="Bemerkung"
     oninput="w.check['${t}'].note=this.value">${w.check[t].note}</textarea>
   </div>`;
 });
}

/* FLUID */
function fluid(l,k,w){
 return `<small>${l} – Liter</small>
 <input ${w.closed?"disabled":""}
 value="${w.fluids[k]||""}"
 oninput="w.fluids['${k}']=this.value;updateTotal(w)">`;
}

/* CALC */
function calc(w){
 let f=0;
 for(let k in w.fluids){
  let l=parseFloat(w.fluids[k])||0;
  f+=l*(w.prices[k]||0);
 }
 return (w.time*w.rate+f+(+w.parts||0)).toFixed(2);
}
function updateTotal(w){
 document.getElementById("total").innerText="Total CHF: "+calc(w);
}

/* SAVE / CLOSE / DELETE */
function saveWork(ci,vi,wi){
 let c=get("customers",[]);
 set("customers",c);
 alert("Rapport gespeichert");
 openWork(ci,vi,wi);
}
function closeWork(ci,vi,wi){
 if(confirm("Rapport wirklich abschliessen? Danach nicht mehr änderbar.")){
  let c=get("customers",[]);
  let w=c[ci].vehicles[vi].works[wi];
  w.closed=true;
  w.closedAt=new Date().toLocaleString();
  set("customers",c);works(ci,vi);
 }
}
function deleteWork(ci,vi,wi){
 if(confirm("Rapport löschen?")){
  let c=get("customers",[]);
  c[ci].vehicles[vi].works.splice(wi,1);
  set("customers",c);works(ci,vi);
 }
}

menu();
</script>
</body>
</html>
