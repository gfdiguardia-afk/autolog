<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --accent: #007aff;
            --danger: #ff3b30;
            --success: #34c759;
            --text: #ffffff;
            --text-dim: #b0b0b0;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        button { 
            width: 100%; margin: 10px 0; padding: 14px; border: none; border-radius: 10px; 
            background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .btn-sec { background: #333; }
        .btn-danger { background: var(--danger); }
        .btn-save { background: var(--success); }

        input, select, textarea {
            width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box;
            background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px;
        }

        .card { 
            background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-left: 4px solid var(--accent);
        }
        .locked { border-left-color: var(--success); opacity: 0.9; }
        
        h3 { margin-top: 25px; color: var(--accent); }
        h4 { margin-bottom: 5px; color: #eee; border-bottom: 1px solid #333; padding-bottom: 5px; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
        hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }

        @media print {
            body { background: white; color: black; }
            button, .btn-danger, hr, header { display: none !important; }
            .card { border: 1px solid #ccc; box-shadow: none; color: black; }
        }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");

const get = (k, d) => {
    try { return JSON.parse(localStorage.getItem(k)) || d; } 
    catch(e) { return d; }
};
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* LOGIN */
function showPin() {
    app.innerHTML = `
    <div style="text-align:center; padding-top:50px">
        <h3>Werkstatt-Login</h3>
        <input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px">
        <button onclick="checkPin()">√ñffnen</button>
    </div>`;
}
function checkPin() {
    if(document.getElementById("pinInput").value === PIN) menu();
    else alert("Falscher PIN");
}

/* MEN√ú */
function menu() {
    app.innerHTML = `
    <button onclick="customers()">üë• Kundenverwaltung</button>
    <button onclick="settings()">‚öôÔ∏è Grundeinstellungen</button>
    <button class="btn-sec" onclick="exportData()">üíæ Daten-Backup</button>`;
}

/* EINSTELLUNGEN */
function settings() {
    let s = get("settings", { rate: 50, oil: 15, coolant: 10, brake: 20, gear: 25, servo: 18, washer: 2 });
    app.innerHTML = `
    <h3>Grundeinstellungen</h3>
    <small>Stundenansatz (CHF)</small>
    <input id="rate" type="number" value="${s.rate}">
    <hr>
    <h4>Preise pro Liter (CHF)</h4>
    <small>Motor√∂l</small><input id="oil" type="number" value="${s.oil}">
    <small>K√ºhlmittel</small><input id="coolant" type="number" value="${s.coolant}">
    <small>Bremsfl√ºssigkeit</small><input id="brake" type="number" value="${s.brake}">
    <small>Getriebe√∂l</small><input id="gear" type="number" value="${s.gear}">
    <small>Servolenkungs√∂l</small><input id="servo" type="number" value="${s.servo}">
    <small>Scheibenwischwasser</small><input id="washer" type="number" value="${s.washer}">
    
    <button class="btn-save" onclick="saveSettings()">Speichern</button>
    <button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function saveSettings() {
    set("settings", {
        rate: +document.getElementById("rate").value,
        oil: +document.getElementById("oil").value,
        coolant: +document.getElementById("coolant").value,
        brake: +document.getElementById("brake").value,
        gear: +document.getElementById("gear").value,
        servo: +document.getElementById("servo").value,
        washer: +document.getElementById("washer").value
    });
    menu();
}

/* KUNDEN */
function customers() {
    let c = get("customers", []);
    let h = "<h3>Kunden</h3>";
    c.forEach((x, i) => h += `<div class="card"><strong>${x.name}</strong><button class="btn-sec" onclick="openCustomer(${i})">√ñffnen</button></div>`);
    app.innerHTML = h + `<button onclick="newCustomer()">+ Neuer Kunde</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function newCustomer() {
    app.innerHTML = `<h3>Neuer Kunde</h3><input id="cname" placeholder="Name"><button class="btn-save" onclick="saveCustomer()">Anlegen</button>`;
}
function saveCustomer() {
    let c = get("customers", []);
    c.push({name: document.getElementById("cname").value, vehicles: []});
    set("customers", c); customers();
}

/* FAHRZEUGE */
function openCustomer(ci) {
    let cust = get("customers", [])[ci];
    let h = `<h3>Fahrzeuge: ${cust.name}</h3>`;
    cust.vehicles.forEach((v, vi) => h += `<div class="card"><strong>${v.brand} ${v.model}</strong><small>${v.plate}</small><button onclick="works(${ci},${vi})">Rapporte</button></div>`);
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug</button><button class="btn-danger" onclick="deleteCustomer(${ci})">Kunde l√∂schen</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`;
}
function newVehicle(ci) {
    app.innerHTML = `<h3>Neues Fahrzeug</h3><input id="vbrand" placeholder="Marke"><input id="vmodel" placeholder="Modell"><input id="vplate" placeholder="Kennzeichen"><button class="btn-save" onclick="saveVehicle(${ci})">Speichern</button>`;
}
function saveVehicle(ci) {
    let c = get("customers", []);
    c[ci].vehicles.push({ brand: document.getElementById("vbrand").value, model: document.getElementById("vmodel").value, plate: document.getElementById("vplate").value, works: [] });
    set("customers", c); openCustomer(ci);
}

/* RAPPORTE LISTE */
function works(ci, vi) {
    let v = get("customers", [])[ci].vehicles[vi];
    let h = `<h3>Rapporte: ${v.brand}</h3>`;
    v.works.forEach((w, wi) => h += `<div class="card ${w.closed?'locked':''}"><strong>${w.date} ‚Äì ${w.type}</strong><button onclick="openWork(${ci},${vi},${wi})">Details</button></div>`);
    app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`;
}

function newWork(ci, vi) {
    let s = get("settings", {rate:50});
    let c = get("customers", []);
    c[ci].vehicles[vi].works.push({
        date: new Date().toLocaleDateString('de-CH'),
        km: "", type: "Service", fluids: {}, note: "",
        time: 0, parts: 0, rate: s.rate, prices: {...s}, closed: false
    });
    set("customers", c);
    openWork(ci, vi, c[ci].vehicles[vi].works.length - 1);
}

/* RAPPORT DETAILS */
function openWork(ci, vi, wi) {
    let c = get("customers", []);
    let w = c[ci].vehicles[vi].works[wi];
    let dis = w.closed ? "disabled" : "";
    
    app.innerHTML = `
    <div id="printArea">
        <h3>${w.type} ‚Äì ${w.date}</h3>
        
        <small>Arbeitsart</small>
        <select ${dis} id="wtype">
            <option ${w.type=="Service"?"selected":""}>Service</option>
            <option ${w.type=="Reifenwechsel"?"selected":""}>Reifenwechsel</option>
            <option ${w.type=="MFK"?"selected":""}>MFK</option>
            <option ${w.type=="Reparatur"?"selected":""}>Reparatur</option>
        </select>

        <small>Kilometerstand</small>
        <input ${dis} id="wkm" type="number" value="${w.km}">
        
        <h4>Fl√ºssigkeiten (Liter)</h4>
        ${fluidRow("Motor√∂l", "oil", w)}
        ${fluidRow("K√ºhlmittel", "coolant", w)}
        ${fluidRow("Bremsfl√ºssigkeit", "brake", w)}
        ${fluidRow("Getriebe√∂l", "gear", w)}
        ${fluidRow("Servolenkungs√∂l", "servo", w)}
        ${fluidRow("Wischwasser", "washer", w)}

        <h4>Arbeit & Teile</h4>
        <small>Arbeitszeit (Stunden)</small>
        <input ${dis} id="wtime" type="number" step="0.1" value="${w.time}">
        <small>Teilekosten (CHF)</small>
        <input ${dis} id="wparts" type="number" value="${w.parts}">
        
        <small>Bemerkungen</small>
        <textarea ${dis} id="wnote">${w.note}</textarea>

        <hr>
        <div style="font-size:22px; font-weight:bold">Total: CHF ${calcTotal(w)}</div>
    </div>
    
    ${!w.closed ? `<button class="btn-save" onclick="saveWork(${ci},${vi},${wi})">Speichern & Schliessen</button>` : ''}
    <button class="btn-sec" onclick="window.print()">üñ®Ô∏è Drucken / PDF</button>
    <button class="btn-sec" onclick="works(${ci},${vi})">Zur√ºck</button>`;
}

function fluidRow(label, key, w) {
    return `<small>${label}</small><input ${w.closed?"disabled":""} type="number" step="0.1" id="f_${key}" value="${w.fluids[key]||0}">`;
}

function calcTotal(w) {
    let fTotal = 0;
    for(let k in w.prices) {
        if(k !== 'rate') fTotal += (parseFloat(w.fluids[k])||0) * (w.prices[k]||0);
    }
    return ( (w.time * w.rate) + fTotal + (+w.parts || 0) ).toFixed(2);
}

function saveWork(ci, vi, wi) {
    let c = get("customers", []);
    let w = c[ci].vehicles[vi].works[wi];
    w.type = document.getElementById("wtype").value;
    w.km = document.getElementById("wkm").value;
    w.time = +document.getElementById("wtime").value;
    w.parts = +document.getElementById("wparts").value;
    w.note = document.getElementById("wnote").value;
    
    // Alle Fl√ºssigkeiten auslesen
    ["oil", "coolant", "brake", "gear", "servo", "washer"].forEach(k => {
        w.fluids[k] = document.getElementById("f_"+k).value;
    });
    
    if(confirm("Rapport abschliessen?")) w.closed = true;
    set("customers", c);
    works(ci, vi);
}

function exportData() {
    let a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([localStorage.getItem("customers")], {type: "application/json"}));
    a.download = "autolog_backup.json"; a.click();
}

showPin();
</script>
</body>
</html>
