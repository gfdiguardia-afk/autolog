<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro Scan</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
            --work-btn: #5856d6;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-work { background: var(--work-btn); }
        .btn-scan { background: #ff9500; }
        .btn-qty { width: auto; padding: 8px 15px; margin: 0 2px; background: #3a3a3c; font-size: 14px; }
        .btn-qty.active { background: var(--accent); }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .locked { border-left-color: var(--success); opacity: 0.9; }
        .check-group { background: #2c2c2e; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 12px; margin: 12px 0; font-size: 16px; width: 100%; }
        .check-item input[type="checkbox"] { width: 24px; height: 24px; flex-shrink: 0; margin: 0; }
        .row-flex { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; width: 100%; }
        .price-tag { color: var(--success); font-weight: bold; font-size: 14px; margin-left: auto; }
        h3 { margin-top: 25px; color: var(--accent); }
        h4 { margin: 15px 0 5px 0; color: #eee; border-bottom: 1px solid #333; padding-bottom: 5px; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
        hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }
        .btn-minus { width: 44px; height: 44px; padding: 0; flex-shrink: 0; margin: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .clickable-header { cursor: pointer; padding: 5px; border-radius: 5px; transition: background 0.2s; }
        .clickable-header:hover { background: #2c2c2e; }
        #camera-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; flex-direction: column; }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<div id="camera-layer">
    <video id="video" style="width: 100%; height: 70%; object-fit: cover;" autoplay playsinline></video>
    <div style="padding: 20px;">
        <button onclick="takeSnapshot()">Foto aufnehmen & Scannen</button>
        <button class="btn-sec" onclick="stopCamera()">Abbrechen</button>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
const PIN = "1234";
const app = document.getElementById("app");

const LABELS = { oil: "Motor√∂l", washer: "Scheibenwischwasser", coolant: "K√ºhlmittel", brake: "Bremsfl√ºssigkeit", gear: "Getriebe√∂l", servo: "Servolenkungs√∂l" };
const TIRE_LABELS = { t_mont: "Reifen montieren", t_vent: "Ventil", t_alu: "Auswuchten Alu", t_met: "Auswuchten Metall", t_clean: "Reinigen", t_store: "Lagern", t_repair: "Reifen repariert" };

const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function startApp() { let s = get("settings", { pinActive: true }); if (s.pinActive) showPin(); else menu(); }
function showPin() { app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Werkstatt-Login</h3><input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px"><button onclick="checkPin()">√ñffnen</button></div>`; }
function checkPin() { if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); }
function menu() { app.innerHTML = `<button onclick="customers()">üë• Kundenverwaltung</button><button onclick="settings()">‚öôÔ∏è Grundeinstellungen</button><button class="btn-sec" onclick="exportData()">üíæ Daten-Backup</button>`; }

function settings() {
    let s = get("settings", { pinActive: true, rate: 50, oil: 15, coolant: 10, brake: 20, gear: 25, servo: 18, washer: 2, cleanPrice: 20, t_mont: 20, t_vent: 5, t_alu: 15, t_met: 10, t_clean: 10, t_store: 40, t_repair: 15, googleKey: "" });
    app.innerHTML = `<h3>Grundeinstellungen</h3>
    <small>Google Cloud API Key (Vision)</small><input id="googleKey" type="text" placeholder="AIza..." value="${s.googleKey||''}">
    <small>PIN-Schutz</small><select id="pinActive"><option value="true" ${s.pinActive?'selected':''}>Aktiv</option><option value="false" ${!s.pinActive?'selected':''}>Aus</option></select>
    <small>Stundenansatz (CHF)</small><input id="rate" type="number" placeholder="CHF" value="${s.rate||''}">
    <small>Reinigung (CHF)</small><input id="cleanPrice" type="number" placeholder="CHF" value="${s.cleanPrice||''}">
    <h4>Reifen Preise (CHF pro Stk)</h4>${Object.keys(TIRE_LABELS).map(k => `<small>${TIRE_LABELS[k]}</small><input id="${k}" type="number" placeholder="CHF" value="${s[k]||''}">`).join('')}
    <h4>Fl√ºssigkeiten pro Liter (CHF)</h4>${Object.keys(LABELS).map(k => `<small>${LABELS[k]}</small><input id="${k}" type="number" placeholder="CHF" value="${s[k]||''}">`).join('')}
    <button class="btn-save" onclick="saveSettings()">Speichern</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}

function saveSettings() {
    let newS = { 
        pinActive: document.getElementById("pinActive").value === "true", 
        rate: +document.getElementById("rate").value, 
        cleanPrice: +document.getElementById("cleanPrice").value,
        googleKey: document.getElementById("googleKey").value 
    };
    Object.keys(LABELS).forEach(k => newS[k] = +document.getElementById(k).value);
    Object.keys(TIRE_LABELS).forEach(k => newS[k] = +document.getElementById(k).value);
    set("settings", newS); menu();
}

function customers() { 
    let c = get("customers", []); 
    let h = `<h3>Kunden</h3>
             <input type="text" id="liveSearch" placeholder="Name, Fahrzeug oder Kennzeichen suchen..." oninput="performSearch()" style="border: 2px solid var(--accent);">
             <div id="customerResults">`;
    c.forEach((x, i) => {
        let searchData = (x.name + " " + x.vehicles.map(v => `${v.brand} ${v.model} ${v.plate}`).join(" ")).toLowerCase();
        h += `<div class="card search-item" data-info="${searchData}">
                <strong>${x.name}</strong>
                <button class="btn-sec" onclick="openCustomer(${i})">√ñffnen</button>
              </div>`;
    });
    app.innerHTML = h + `</div><button onclick="newCustomer()">+ Neuer Kunde</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`; 
}

function performSearch() {
    let query = document.getElementById("liveSearch").value.toLowerCase();
    let items = document.querySelectorAll(".search-item");
    items.forEach(item => {
        let info = item.getAttribute("data-info");
        item.style.display = info.includes(query) ? "block" : "none";
    });
}

function newCustomer() { app.innerHTML = `<h3>Neuer Kunde</h3><input id="cname" placeholder="Name"><button class="btn-save" onclick="saveCustomer()">Anlegen</button>`; }
function saveCustomer() { let c = get("customers", []); c.push({name: document.getElementById("cname").value, vehicles: []}); set("customers", c); customers(); }

function openCustomer(ci) { 
    let cust = get("customers", [])[ci]; 
    let h = `<h3>Fahrzeugliste: ${cust.name}</h3>`; 
    cust.vehicles.forEach((v, vi) => {
        h += `<div class="card">
                <div class="clickable-header" onclick="editVehicle(${ci},${vi})">
                    <strong style="font-size:18px">${v.brand} ${v.model}</strong> 
                    <span style="background:#333; padding:2px 6px; border-radius:4px; font-family:monospace; margin-left:10px">${v.plate || '---'}</span>
                    <small style="color:var(--accent)">‚ûî Bearbeiten / Details</small>
                </div>
                <small style="margin-top:10px">N√§chste Arbeiten / Notiz:</small>
                <textarea style="margin-top:5px; height:60px; font-size:14px" placeholder="z.B. Bremsen in 10T KM" oninput="updateVehicleNote(${ci},${vi},this.value)">${v.nextWorkNote || ''}</textarea>
                <button onclick="works(${ci},${vi})">Rapporte</button>
                <button class="btn-danger" style="padding:5px; margin-top:5px; font-size:12px" onclick="deleteVehicle(${ci},${vi})">Fahrzeug l√∂schen</button>
              </div>`;
    }); 
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug</button><button class="btn-danger" onclick="deleteCustomer(${ci})">Kunde l√∂schen</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`; 
}

function editVehicle(ci, vi) {
    let v = get("customers", [])[ci].vehicles[vi];
    renderVehicleForm(ci, vi, v);
}

function renderVehicleForm(ci, vi, v = null) {
    let isNew = v === null;
    let title = isNew ? "Neues Fahrzeug" : "Fahrzeug anpassen";
    let data = v || { brand: '', model: '', plate: '', vin: '', stammnr: '', firstReg: '', cc: '' };
    
    app.innerHTML = `<h3>${title}</h3>
    <button class="btn-scan" onclick="startScan()">üì∑ Fahrzeugausweis scannen</button>
    <small>Marke</small><input id="vbrand" value="${data.brand}">
    <small>Modell</small><input id="vmodel" value="${data.model}">
    <small>Kennzeichen</small><input id="vplate" value="${data.plate}" oninput="this.value = this.value.toUpperCase()">
    <small>Fahrgestell-Nr (VIN)</small><input id="vvin" value="${data.vin || ''}">
    <small>Stammnummer</small><input id="vstammnr" value="${data.stammnr || ''}">
    <small>1. Inverkehrsetzung</small><input id="vfirstReg" value="${data.firstReg || ''}" placeholder="TT.MM.JJJJ">
    <small>Hubraum (ccm)</small><input id="vcc" type="number" value="${data.cc || ''}">
    
    <button class="btn-save" onclick="saveVehicleData(${ci},${vi},${isNew})">Speichern</button>
    <button class="btn-sec" onclick="openCustomer(${ci})">Abbrechen</button>`;
}

function saveVehicleData(ci, vi, isNew) {
    let c = get("customers", []);
    let vehicleData = {
        brand: document.getElementById("vbrand").value,
        model: document.getElementById("vmodel").value,
        plate: document.getElementById("vplate").value,
        vin: document.getElementById("vvin").value,
        stammnr: document.getElementById("vstammnr").value,
        firstReg: document.getElementById("vfirstReg").value,
        cc: document.getElementById("vcc").value,
        nextWorkNote: isNew ? "" : c[ci].vehicles[vi].nextWorkNote,
        works: isNew ? [] : c[ci].vehicles[vi].works
    };

    if (isNew) c[ci].vehicles.push(vehicleData);
    else c[ci].vehicles[vi] = vehicleData;

    set("customers", c);
    openCustomer(ci);
}

// --- SCANNER LOGIC ---
let streamRef = null;

async function startScan() {
    let s = get("settings", {});
    if (!s.googleKey) return alert("Bitte Google API Key in den Einstellungen hinterlegen!");
    
    document.getElementById("camera-layer").style.display = "flex";
    try {
        streamRef = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById("video").srcObject = streamRef;
    } catch (err) { alert("Kamera-Zugriff verweigert"); stopCamera(); }
}

function stopCamera() {
    if (streamRef) streamRef.getTracks().forEach(t => t.stop());
    document.getElementById("camera-layer").style.display = "none";
}

async function takeSnapshot() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    
    const base64Image = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
    stopCamera();
    processOCR(base64Image);
}

async function processOCR(base64) {
    let key = get("settings", {}).googleKey;
    app.innerHTML = "<h3>Scanne... bitte warten...</h3>";
    
    try {
        const resp = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
            method: "POST",
            body: JSON.stringify({
                requests: [{
                    image: { content: base64 },
                    features: [{ type: "TEXT_DETECTION" }]
                }]
            })
        });
        const data = await resp.json();
        const text = data.responses[0].fullTextAnnotation.text;
        parseVehicleData(text);
    } catch (e) {
        alert("Fehler beim Scannen: " + e.message);
        menu();
    }
}

function parseVehicleData(rawText) {
    // Regex f√ºr Schweizer Fahrzeugausweis Felder
    const vinMatch = rawText.match(/[A-Z0-9]{17}/); // Fahrgestellnummer
    const plateMatch = rawText.match(/([A-Z]{2}\s?\d{3,6})/); // Kennzeichen
    const stammnrMatch = rawText.match(/(\d{3}\.\d{3}\.\d{3})/); // Stammnummer
    const dateMatch = rawText.match(/(\d{2}\.\d{2}\.\d{4})/); // 1. Inverkehrsetzung
    const ccMatch = rawText.match(/(\d{3,4})\s?cm/i); // Hubraum

    // Marke/Modell Logik (oft in der N√§he von Feld 24)
    let brand = "";
    let lines = rawText.split("\n");
    if(lines.length > 5) brand = lines[2] + " " + lines[3]; // Grobe Sch√§tzung

    // Gefundene Daten ins Formular (Werte bleiben im Speicher bis "Speichern" geklickt wird)
    document.getElementById("vbrand").value = brand.trim();
    document.getElementById("vvin").value = vinMatch ? vinMatch[0] : "";
    document.getElementById("vplate").value = plateMatch ? plateMatch[0].replace(/\s/g, "") : "";
    document.getElementById("vstammnr").value = stammnrMatch ? stammnrMatch[0] : "";
    document.getElementById("vfirstReg").value = dateMatch ? dateMatch[0] : "";
    document.getElementById("vcc").value = ccMatch ? ccMatch[1] : "";
    
    alert("Scan abgeschlossen. Bitte Daten kurz pr√ºfen.");
    // UI Refresh erzwingen (da wir app.innerHTML w√§hrend Scan √ºberschrieben haben)
    // Wir lassen die Felder einfach so stehen, der User muss speichern.
}

// --- REST DER FUNKTIONEN (Original √ºbernommen) ---

function updateVehicleNote(ci, vi, note) {
    let c = get("customers", []);
    c[ci].vehicles[vi].nextWorkNote = note;
    set("customers", c);
}

function deleteCustomer(ci) { if(confirm("Kunde wirklich l√∂schen?")) { let c = get("customers", []); c.splice(ci, 1); set("customers", c); customers(); } }
function deleteVehicle(ci, vi) { if(confirm("Fahrzeug wirklich l√∂schen?")) { let c = get("customers", []); c[ci].vehicles.splice(vi, 1); set("customers", c); openCustomer(ci); } }
function newVehicle(ci) { renderVehicleForm(ci, null, null); }

function works(ci, vi) { let v = get("customers", [])[ci].vehicles[vi]; let h = `<h3>Rapporte: ${v.brand}</h3>`; v.works.forEach((w, wi) => h += `<div class="card ${w.closed?'locked':''}"><strong>${w.date} ‚Äì ${w.types?.join(', ') || 'Rapport'}</strong><button onclick="openWork(${ci},${vi},${wi})">Details</button></div>`); app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`; }
function newWork(ci, vi) { let s = get("settings", {rate:50}); let c = get("customers", []); c[ci].vehicles[vi].works.push({ date: new Date().toLocaleDateString('de-CH'), km: "", types: [], mfkPoints: {}, tireData: {}, serviceFields: {}, fluids: {}, note: "", time: 0, partsList: [], workList: [], rate: s.rate, prices: {...s}, closed: false }); set("customers", c); openWork(ci, vi, c[ci].vehicles[vi].works.length - 1); }

function openWork(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; let dis = w.closed ? "disabled" : "";
    app.innerHTML = `<h3>Rapport ‚Äì ${w.date}</h3>
    <small>Arbeitsart</small>
    <div class="check-group">
        ${["Service","MFK","Fl√ºssigkeiten","Reifenwechsel","Reparatur"].map(t => `<label class="check-item"><input ${dis} type="checkbox" onchange="toggleType('${t}',${ci},${vi},${wi})" ${w.types?.includes(t)?'checked':''}> <span>${t}</span></label>`).join('')}
    </div>
    <small>KM-Stand *</small><input ${dis} id="wkm" type="number" placeholder="Zwingend" value="${w.km}" oninput="updateW(${ci},${vi},${wi})">
    <div id="dynamicFields"></div><div id="fluidSection"></div>
    <div id="repairSection" style="display:${w.types?.includes('Reparatur')?'block':'none'}">
        <h4>Sonstige Teile / Arbeit</h4>
        <div id="partsContainer"></div>
        <div class="row-flex">
            <button ${dis} class="btn-save" onclick="addPartRow(${ci},${vi},${wi})">+ Teile</button>
            <button ${dis} class="btn-work" onclick="addWorkRow(${ci},${vi},${wi})">+ Arbeit</button>
        </div>
    </div>
    <textarea ${dis} id="wnote" placeholder="Bemerkungen" oninput="updateW(${ci},${vi},${wi})">${w.note}</textarea>
    <hr><div style="font-size:24px; font-weight:bold; color:var(--success)" id="liveTotal">Total: CHF ${calcTotal(w)}</div>
    ${!w.closed ? `<button onclick="saveW(${ci},${vi},${wi}, false)">üíæ Zwischenspeichern</button><button class="btn-save" onclick="saveW(${ci},${vi},${wi}, true)">‚úÖ Rapport abschliessen</button>` : ''}
    <button class="btn-danger" onclick="deleteWork(${ci},${vi},${wi})">Rapport l√∂schen</button>
    <button class="btn-sec" onclick="works(${ci},${vi})">Zur√ºck</button>`;
    renderParts(ci, vi, wi); renderDynamic(ci, vi, wi);
}

function deleteWork(ci, vi, wi) { if(confirm("Rapport wirklich l√∂schen?")) { let c = get("customers", []); c[ci].vehicles[vi].works.splice(wi, 1); set("customers", c); works(ci, vi); } }

function renderDynamic(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; let dis = w.closed ? "disabled" : ""; let dHtml = "";
    if(w.types?.includes("Service")) {
        dHtml += `<h4>Service Details</h4>
        <small>Jahres Inspektion (Std)</small><input ${dis} type="number" step="0.1" id="s_insp" placeholder="Std" value="${w.serviceFields.inspection||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>√ñlfilter (Material)</small><input ${dis} type="number" id="s_oilf" placeholder="CHF" value="${w.serviceFields.oilFilter||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>Pollenfilter (Material)</small><input ${dis} type="number" id="s_poll" placeholder="CHF" value="${w.serviceFields.pollenFilter||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>Luftfilter (Material)</small><input ${dis} type="number" id="s_air" placeholder="CHF" value="${w.serviceFields.airFilter||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>Kraftstofffilter (Material)</small><input ${dis} type="number" id="s_fuel" placeholder="CHF" value="${w.serviceFields.fuelFilter||''}" oninput="updateW(${ci},${vi},${wi})">
        <hr><small>Z√ºndkerzen (Material)</small><input ${dis} type="number" id="s_plug" placeholder="CHF" value="${w.serviceFields.plugs||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>Z√ºndkerzen ersetzen (Std)</small><input ${dis} type="number" step="0.1" id="s_plugT" placeholder="Std" value="${w.serviceFields.plugsT||''}" oninput="updateW(${ci},${vi},${wi})">
        <hr><small>Zahnriemensatz (Material)</small><input ${dis} type="number" id="s_belt" placeholder="CHF" value="${w.serviceFields.belt||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>Zahnriemen ersetzen (Std)</small><input ${dis} type="number" step="0.1" id="s_beltT" placeholder="Std" value="${w.serviceFields.beltT||''}" oninput="updateW(${ci},${vi},${wi})">
        <hr><small>Wasserpumpe (Material)</small><input ${dis} type="number" id="s_pump" placeholder="CHF" value="${w.serviceFields.pump||''}" oninput="updateW(${ci},${vi},${wi})">
        <small>Keilrippenriemen (Material)</small><input ${dis} type="number" id="s_ribM" placeholder="CHF" value="${w.serviceFields.ribbedM||''}" oninput="updateW(${ci},${vi},${wi})">
        <label class="check-item"><input ${dis} type="checkbox" id="s_rib" ${w.serviceFields.ribbed?'checked':''} onchange="updateW(${ci},${vi},${wi})"> <span>Keilrippenriemen i.O.</span></label>`;
    }
    if(w.types?.includes("MFK")) {
        dHtml += `<h4>MFK Checkliste</h4><small>MFK richten (Std)</small><input ${dis} type="number" step="0.1" id="m_prep" placeholder="Std" value="${w.mfkPrepTime||''}" oninput="updateW(${ci},${vi},${wi})">
        <div class="check-group">${["Licht gepr√ºft","Licht eingestellt","Bremsen gepr√ºft","Auspuff gepr√ºft","Motor & Karosserie gereinigt"].map(p => `<label class="check-item"><input ${dis} type="checkbox" onchange="toggleMfk('${p}',${ci},${vi},${wi})" ${w.mfkPoints[p]?'checked':''}> <span>${p}</span> ${(p==="Motor & Karosserie gereinigt" && w.mfkPoints[p]) ? `<span class="price-tag">+ ${w.prices.cleanPrice}</span>` : ""}</label>`).join('')}</div>`;
    }
    if(w.types?.includes("Reifenwechsel")) {
        dHtml += `<h4>Reifen Service</h4><div class="check-group">`;
        Object.keys(TIRE_LABELS).forEach(k => {
            let val = w.tireData[k] || 0;
            dHtml += `<div class="tire-row"><small>${TIRE_LABELS[k]}</small>
                <div class="row-flex">
                    <button ${dis} class="btn-qty ${val==2?'active':''}" onclick="setTireQty('${k}',2,${ci},${vi},${wi})">2</button>
                    <button ${dis} class="btn-qty ${val==4?'active':''}" onclick="setTireQty('${k}',4,${ci},${vi},${wi})">4</button>
                    <input ${dis} type="number" placeholder="Anz" value="${val||''}" oninput="setTireQty('${k}',this.value,${ci},${vi},${wi})" style="margin:0; flex:1">
                    <span class="price-tag">${(val * w.prices[k]).toFixed(2)}</span>
                </div></div>`;
        });
        dHtml += `</div>`;
    }
    document.getElementById("dynamicFields").innerHTML = dHtml;
    if(w.types?.includes("Service") || w.types?.includes("Fl√ºssigkeiten")) {
        document.getElementById("fluidSection").innerHTML = `<h4>Fl√ºssigkeiten (L)</h4>` + Object.keys(LABELS).map(k => `<small>${LABELS[k]}</small><input ${dis} id="f_${k}" type="number" step="0.1" placeholder="Liter" value="${w.fluids[k]||''}" oninput="updateW(${ci},${vi},${wi})">`).join('');
    }
}

function setTireQty(k, q, ci, vi, wi) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].tireData[k] = +q; set("customers", c); renderDynamic(ci, vi, wi); updateW(ci, vi, wi); }

function renderParts(ci, vi, wi) { 
    let w = get("customers", [])[ci].vehicles[vi].works[wi]; 
    let d = w.closed ? "disabled" : ""; 
    let html = "";
    w.partsList.forEach((p, i) => {
        html += `<div class="row-flex">
            <input ${d} placeholder="Teil Bezeichnung" value="${p.t}" oninput="updatePart(${ci},${vi},${wi},${i},'t',this.value)">
            <input ${d} type="number" placeholder="CHF" style="width:100px" value="${p.p||''}" oninput="updatePart(${ci},${vi},${wi},${i},'p',this.value)">
            <button ${d} class="btn-danger btn-minus" onclick="removePartRow(${ci},${vi},${wi},${i})">-</button>
        </div>`;
    });
    w.workList.forEach((work, i) => {
        html += `<div class="row-flex">
            <input ${d} placeholder="Arbeit Bezeichnung" value="${work.t}" oninput="updateWorkRowItem(${ci},${vi},${wi},${i},'t',this.value)">
            <input ${d} type="number" step="0.1" placeholder="Std" style="width:100px" value="${work.h||''}" oninput="updateWorkRowItem(${ci},${vi},${wi},${i},'h',this.value)">
            <button ${d} class="btn-danger btn-minus" onclick="removeWorkRow(${ci},${vi},${wi},${i})">-</button>
        </div>`;
    });
    document.getElementById("partsContainer").innerHTML = html;
}

function addPartRow(ci, vi, wi) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].partsList.push({t:"",p:0}); set("customers", c); renderParts(ci, vi, wi); }
function removePartRow(ci, vi, wi, i) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].partsList.splice(i, 1); set("customers", c); renderParts(ci, vi, wi); updateW(ci, vi, wi); }
function addWorkRow(ci, vi, wi) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].workList.push({t:"",h:0}); set("customers", c); renderParts(ci, vi, wi); }
function removeWorkRow(ci, vi, wi, i) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].workList.splice(i, 1); set("customers", c); renderParts(ci, vi, wi); updateW(ci, vi, wi); }
function updatePart(ci, vi, wi, i, k, v) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].partsList[i][k] = k==='p'?+v:v; set("customers", c); updateW(ci, vi, wi); }
function updateWorkRowItem(ci, vi, wi, i, k, v) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].workList[i][k] = k==='h'?+v:v; set("customers", c); updateW(ci, vi, wi); }

function toggleType(t,ci,vi,wi) { 
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; 
    w.types=w.types||[]; if(w.types.includes(t)) w.types=w.types.filter(x=>x!==t); else w.types.push(t); 
    set("customers", c); 
    let repSec = document.getElementById("repairSection");
    if(repSec) repSec.style.display = w.types.includes('Reparatur') ? 'block' : 'none';
    renderDynamic(ci,vi,wi); updateW(ci,vi,wi); 
}
function toggleMfk(p,ci,vi,wi) { let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; w.mfkPoints[p]=!w.mfkPoints[p]; set("customers", c); renderDynamic(ci,vi,wi); updateW(ci,vi,wi); }

function updateW(ci,vi,wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    w.km = document.getElementById("wkm").value; w.note = document.getElementById("wnote").value;
    Object.keys(LABELS).forEach(k => { let el = document.getElementById("f_"+k); if(el) w.fluids[k] = el.value; });
    if(w.types.includes("Service")) {
        w.serviceFields = {
            inspection: +document.getElementById("s_insp").value, oilFilter: +document.getElementById("s_oilf").value, pollenFilter: +document.getElementById("s_poll").value,
            airFilter: +document.getElementById("s_air").value, fuelFilter: +document.getElementById("s_fuel").value, plugs: +document.getElementById("s_plug").value,
            plugsT: +document.getElementById("s_plugT").value, belt: +document.getElementById("s_belt").value, beltT: +document.getElementById("s_beltT").value,
            pump: +document.getElementById("s_pump").value, ribbed: document.getElementById("s_rib").checked, ribbedM: +document.getElementById("s_ribM").value
        };
    }
    if(w.types.includes("MFK")) w.mfkPrepTime = +document.getElementById("m_prep").value;
    document.getElementById("liveTotal").innerText = "Total: CHF " + calcTotal(w); set("customers", c);
}

function calcTotal(w) {
    let fT = 0; Object.keys(LABELS).forEach(k => fT += (parseFloat(w.fluids[k])||0) * (w.prices[k]||0));
    let pT = w.partsList.reduce((sum, p) => sum + (+p.p || 0), 0);
    let workListTotal = (w.workList || []).reduce((sum, wk) => sum + ((+wk.h || 0) * w.rate), 0);
    let sE = (w.serviceFields.inspection||0)*w.rate + (w.serviceFields.oilFilter||0) + (w.serviceFields.pollenFilter||0) + (w.serviceFields.airFilter||0) + (w.serviceFields.fuelFilter||0) + (w.serviceFields.plugs||0) + (w.serviceFields.plugsT||0)*w.rate + (w.serviceFields.belt||0) + (w.serviceFields.beltT||0)*w.rate + (w.serviceFields.pump||0) + (w.serviceFields.ribbedM||0);
    let mE = (w.mfkPrepTime || 0) * w.rate;
    let cleanE = (w.mfkPoints["Motor & Karosserie gereinigt"]) ? (w.prices.cleanPrice || 0) : 0;
    let tireE = 0; Object.keys(TIRE_LABELS).forEach(k => tireE += (w.tireData[k] || 0) * (w.prices[k] || 0));
    return ( fT + pT + workListTotal + sE + mE + cleanE + tireE ).toFixed(2);
}

function saveW(ci, vi, wi, close) {
    if(!document.getElementById("wkm").value) { alert("KM-Stand fehlt!"); return; }
    if(close && !confirm("Abschliessen? Keine √Ñnderungen mehr m√∂glich.")) return;
    updateW(ci, vi, wi);
    if(close) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].closed = true; set("customers", c); works(ci, vi); } else alert("Gespeichert");
}

function exportData() { let a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([localStorage.getItem("customers")], {type: "application/json"})); a.download = "autolog_backup.json"; a.click(); }
startApp();
</script>
</body>
</html>
