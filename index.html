<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
            --work-btn: #5856d6;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-work { background: var(--work-btn); }
        .btn-qty { width: auto; padding: 8px 15px; margin: 0 2px; background: #3a3a3c; font-size: 14px; }
        .btn-qty.active { background: var(--accent); }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .locked { border-left-color: var(--success); opacity: 0.9; }
        .check-group { background: #2c2c2e; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 12px; margin: 12px 0; font-size: 16px; width: 100%; }
        .check-item input[type="checkbox"] { width: 24px; height: 24px; flex-shrink: 0; margin: 0; }
        .row-flex { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; width: 100%; }
        .price-tag { color: var(--success); font-weight: bold; font-size: 14px; margin-left: auto; }
        h3 { margin-top: 25px; color: var(--accent); }
        h4 { margin: 15px 0 5px 0; color: #eee; border-bottom: 1px solid #333; padding-bottom: 5px; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
        hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }
        .btn-minus { width: 44px; height: 44px; padding: 0; flex-shrink: 0; margin: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .clickable-header { cursor: pointer; padding: 5px; border-radius: 5px; transition: background 0.2s; }
        .clickable-header:hover { background: #2c2c2e; }
        .img-preview { width: 100%; border-radius: 8px; margin-top: 10px; display: none; cursor: pointer; border: 1px solid #444; }

        /* Print Styles f√ºr Schweizer Fensterbrief (Rechts) */
        @media print {
            body * { visibility: hidden; background: white !important; color: black !important; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 0; font-size: 11pt; }
            .no-print { display: none !important; }
            .inv-table { width: 100%; border-collapse: collapse; margin-top: 40px; }
            .inv-table th { border-bottom: 2px solid #000; text-align: left; padding: 8px; }
            .inv-table td { border-bottom: 1px solid #eee; padding: 8px; }
            .total-row { font-weight: bold; font-size: 13pt; }
            
            /* Positionierung f√ºr Fensterbrief rechts */
            .address-client { 
                margin-left: 110mm; /* Schweizer Standard f√ºr Fenster rechts */
                margin-top: 45mm; 
                height: 40mm;
                font-size: 11pt;
                line-height: 1.4;
            }
            .header-info { margin-top: 20mm; margin-left: 10mm; }
        }
    </style>
</head>
<body>

<header class="no-print">AutoLog Pro</header>
<div class="container no-print" id="app"></div>
<div id="printArea"></div>

<script>
// Logik-Kern bleibt identisch wie vorher
const PIN = "1234";
const app = document.getElementById("app");
const LABELS = { oil: "Motor√∂l", washer: "Scheibenwischwasser", coolant: "K√ºhlmittel", brake: "Bremsfl√ºssigkeit", gear: "Getriebe√∂l", servo: "Servolenkungs√∂l" };
const TIRE_LABELS = { t_mont: "Reifen montieren", t_vent: "Ventil", t_alu: "Auswuchten Alu", t_met: "Auswuchten Metall", t_clean: "Reinigen", t_store: "Lagern", t_repair: "Reifen repariert" };
const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function startApp() { let s = get("settings", { pinActive: true }); if (s.pinActive) showPin(); else menu(); }
function showPin() { app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Werkstatt-Login</h3><input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px"><button onclick="checkPin()">√ñffnen</button></div>`; }
function checkPin() { if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); }
function menu() { app.innerHTML = `<button onclick="customers()">üë• Kundenverwaltung</button><button onclick="settings()">‚öôÔ∏è Grundeinstellungen</button><button class="btn-sec" onclick="exportData()">üíæ Daten-Backup</button>`; }

// ... [Andere Funktionen wie settings, customers, customerForm, etc. bleiben gleich] ...
// (Aus Platzgr√ºnden hier gek√ºrzt, Fokus auf dem ge√§nderten PDF-Teil)

function settings() {
    let s = get("settings", { pinActive: true, rate: 50, oil: 15, coolant: 10, brake: 20, gear: 25, servo: 18, washer: 2, cleanPrice: 20, t_mont: 20, t_vent: 5, t_alu: 15, t_met: 10, t_clean: 10, t_store: 40, t_repair: 15 });
    app.innerHTML = `<h3>Grundeinstellungen</h3><small>PIN-Schutz</small><select id="pinActive"><option value="true" ${s.pinActive?'selected':''}>Aktiv</option><option value="false" ${!s.pinActive?'selected':''}>Aus</option></select>
    <small>Stundenansatz (CHF)</small><input id="rate" type="number" placeholder="CHF" value="${s.rate||''}">
    <small>Reinigung (CHF)</small><input id="cleanPrice" type="number" placeholder="CHF" value="${s.cleanPrice||''}">
    <h4>Reifen Preise (CHF pro Stk)</h4>${Object.keys(TIRE_LABELS).map(k => `<small>${TIRE_LABELS[k]}</small><input id="${k}" type="number" placeholder="CHF" value="${s[k]||''}">`).join('')}
    <h4>Fl√ºssigkeiten pro Liter (CHF)</h4>${Object.keys(LABELS).map(k => `<small>${LABELS[k]}</small><input id="${k}" type="number" placeholder="CHF" value="${s[k]||''}">`).join('')}
    <button class="btn-save" onclick="saveSettings()">Speichern</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function saveSettings() {
    let newS = { pinActive: document.getElementById("pinActive").value === "true", rate: +document.getElementById("rate").value, cleanPrice: +document.getElementById("cleanPrice").value };
    Object.keys(LABELS).forEach(k => newS[k] = +document.getElementById(k).value);
    Object.keys(TIRE_LABELS).forEach(k => newS[k] = +document.getElementById(k).value);
    set("settings", newS); menu();
}
function customers() { 
    let c = get("customers", []); 
    let h = `<h3>Kunden</h3><input type="text" id="liveSearch" placeholder="Name, Firma, VIN oder Kennzeichen..." oninput="performSearch()" style="border: 2px solid var(--accent);"><div id="customerResults">`;
    c.forEach((x, i) => {
        let nameStr = `${x.lastname||''} ${x.firstname||''} ${x.company||''}`.trim();
        let searchData = (nameStr + " " + (x.vehicles||[]).map(v => `${v.brand} ${v.model} ${v.plate} ${v.vin}`).join(" ")).toLowerCase();
        h += `<div class="card search-item" data-info="${searchData}"><div class="row-flex" style="justify-content: space-between;"><strong>${nameStr || 'Unbenannter Kunde'}</strong><button class="btn-sec" style="width: auto; padding: 5px 10px;" onclick="customerForm(${i})">‚úé</button></div><button class="btn-sec" onclick="openCustomer(${i})">Fahrzeuge √∂ffnen</button></div>`;
    });
    app.innerHTML = h + `</div><button onclick="customerForm()">+ Neuer Kunde</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`; 
}
function customerForm(ci = null) {
    let c = ci !== null ? get("customers", [])[ci] : {};
    app.innerHTML = `<h3>${ci !== null ? 'Kunde bearbeiten' : 'Neuer Kunde'}</h3><small>Firma</small><input id="c_company" value="${c.company || ''}"><small>Nachname</small><input id="c_lastname" value="${c.lastname || ''}"><small>Vorname</small><input id="c_firstname" value="${c.firstname || ''}"><small>Strasse / Nr.</small><input id="c_street" value="${c.street || ''}"><div class="row-flex"><div style="flex:1"><small>PLZ</small><input id="c_zip" type="number" value="${c.zip || ''}"></div><div style="flex:2"><small>Ort</small><input id="c_city" value="${c.city || ''}"></div></div><small>Geburtsdatum</small><input id="c_birth" type="text" placeholder="TT.MM.JJJJ" value="${c.birthDate || ''}"><small>Telefonnummer</small><input id="c_phone" type="tel" value="${c.phone || ''}"><small>E-Mail</small><input id="c_email" type="email" value="${c.email || ''}"><button class="btn-save" onclick="saveCustomerData(${ci})">Speichern</button><button class="btn-sec" onclick="customers()">Abbrechen</button>`;
}
function saveCustomerData(ci) {
    let cList = get("customers", []);
    let c = { company: document.getElementById("c_company").value, lastname: document.getElementById("c_lastname").value, firstname: document.getElementById("c_firstname").value, street: document.getElementById("c_street").value, zip: document.getElementById("c_zip").value, city: document.getElementById("c_city").value, birthDate: document.getElementById("c_birth").value, phone: document.getElementById("c_phone").value, email: document.getElementById("c_email").value };
    if (ci !== null) { c.vehicles = cList[ci].vehicles || []; cList[ci] = c; } else { c.vehicles = []; cList.push(c); }
    set("customers", cList); customers();
}
function performSearch() {
    let query = document.getElementById("liveSearch").value.toLowerCase();
    document.querySelectorAll(".search-item").forEach(item => item.style.display = item.getAttribute("data-info").includes(query) ? "block" : "none");
}
function openCustomer(ci) { 
    let cust = get("customers", [])[ci]; 
    let h = `<h3>Fahrzeuge: ${cust.lastname||''}</h3>`; 
    (cust.vehicles||[]).forEach((v, vi) => {
        h += `<div class="card"><div class="clickable-header" onclick="editVehicle(${ci},${vi})"><strong>${v.brand || ''} ${v.model || ''}</strong> <span style="background:#333; padding:2px 6px; border-radius:4px;">${v.plate || '---'}</span></div><textarea style="margin-top:5px; height:60px;" placeholder="Notiz" oninput="updateVehicleNote(${ci},${vi},this.value)">${v.nextWorkNote || ''}</textarea><button onclick="works(${ci},${vi})">Rapporte</button></div>`;
    }); 
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`; 
}

function updateVehicleNote(ci, vi, note) { let c = get("customers", []); c[ci].vehicles[vi].nextWorkNote = note; set("customers", c); }

function editVehicle(ci, vi) { let v = get("customers", [])[ci].vehicles[vi]; app.innerHTML = vehicleFormHtml(v, ci, vi); }
function newVehicle(ci) { app.innerHTML = vehicleFormHtml({}, ci, null); }
function vehicleFormHtml(v = {}, ci, vi = null) {
    return `<h3>Fahrzeugdaten</h3><small>Kennzeichen</small><input id="vplate" value="${v.plate || ''}"><small>Marke</small><input id="vbrand" value="${v.brand || ''}"><small>Modell</small><input id="vmodel" value="${v.model || ''}"><small>VIN</small><input id="vvin" value="${v.vin || ''}"><button class="btn-save" onclick="updateVehicleData(${ci},${vi})">Speichern</button><button class="btn-sec" onclick="openCustomer(${ci})">Abbrechen</button>`;
}
function updateVehicleData(ci, vi) {
    let c = get("customers", []); let v;
    if (vi === null) { v = { works: [] }; c[ci].vehicles.push(v); vi = c[ci].vehicles.length - 1; } else { v = c[ci].vehicles[vi]; }
    v.plate = document.getElementById("vplate").value; v.brand = document.getElementById("vbrand").value; v.model = document.getElementById("vmodel").value; v.vin = document.getElementById("vvin").value;
    set("customers", c); openCustomer(ci);
}

function works(ci, vi) { 
    let v = get("customers", [])[ci].vehicles[vi]; 
    let h = `<h3>Rapporte: ${v.brand}</h3>`; 
    (v.works||[]).forEach((w, wi) => h += `<div class="card"><strong>${w.date}</strong><button onclick="openWork(${ci},${vi},${wi})">√ñffnen</button></div>`); 
    app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`; 
}
function newWork(ci, vi) { 
    let s = get("settings", {rate:50}); let c = get("customers", []); 
    c[ci].vehicles[vi].works.push({ date: new Date().toLocaleDateString('de-CH'), km: "", types: [], mfkPoints: {}, tireData: {}, serviceFields: {}, fluids: {}, partsList: [], workList: [], rate: s.rate, prices: {...s}, closed: false }); 
    set("customers", c); openWork(ci, vi, c[ci].vehicles[vi].works.length - 1); 
}

function openWork(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; let dis = w.closed ? "disabled" : "";
    app.innerHTML = `<h3>Rapport ‚Äì ${w.date}</h3>
    <small>KM-Stand *</small><input ${dis} id="wkm" type="number" value="${w.km}" oninput="updateW(${ci},${vi},${wi})">
    <div class="check-group">${["Service","MFK","Fl√ºssigkeiten","Reifenwechsel","Reparatur"].map(t => `<label class="check-item"><input ${dis} type="checkbox" onchange="toggleType('${t}',${ci},${vi},${wi})" ${w.types?.includes(t)?'checked':''}> ${t}</label>`).join('')}</div>
    <div id="dynamicFields"></div><div id="fluidSection"></div>
    <div id="repairSection" style="display:${w.types?.includes('Reparatur')?'block':'none'}">
        <div id="partsContainer"></div>
        <button ${dis} onclick="addPartRow(${ci},${vi},${wi})">+ Teil</button>
        <button ${dis} onclick="addWorkRow(${ci},${vi},${wi})">+ Arbeit</button>
    </div>
    <hr><strong>Total: CHF ${calcTotal(w)}</strong>
    <button class="btn-work" onclick="generateInvoice(${ci},${vi},${wi})">üìÑ Rechnung generieren</button>
    <button class="btn-sec" onclick="works(${ci},${vi})">Zur√ºck</button>`;
    renderParts(ci, vi, wi); renderDynamic(ci, vi, wi);
}

// PDF LOGIK - OPTIMIERT F√úR SCHWEIZ FENSTER RECHTS
function generateInvoice(ci, vi, wi) {
    const cList = get("customers", []); const cust = cList[ci]; const v = cust.vehicles[vi]; const w = v.works[wi];
    let rows = "";
    
    // Positionen zusammenstellen (nur bef√ºllte)
    Object.keys(LABELS).forEach(k => { if(parseFloat(w.fluids[k]) > 0) rows += `<tr><td>${LABELS[k]}</td><td>${w.fluids[k]} L</td><td>${w.prices[k]}</td><td>${(w.fluids[k]*w.prices[k]).toFixed(2)}</td></tr>`; });
    const sf = w.serviceFields || {};
    ["oilFilter", "pollenFilter", "airFilter", "fuelFilter", "plugs", "belt", "pump", "ribbedM"].forEach(f => {
        if(sf[f] > 0) rows += `<tr><td>${f}</td><td>1 Stk</td><td>${sf[f]}</td><td>${sf[f].toFixed(2)}</td></tr>`;
    });
    let totalH = (sf.inspection||0) + (sf.plugsT||0) + (sf.beltT||0) + (w.mfkPrepTime||0);
    (w.workList||[]).forEach(wk => totalH += (wk.h || 0));
    if(totalH > 0) rows += `<tr><td>Arbeitsaufwand total</td><td>${totalH.toFixed(1)} Std</td><td>${w.rate}</td><td>${(totalH * w.rate).toFixed(2)}</td></tr>`;
    Object.keys(TIRE_LABELS).forEach(k => { if(w.tireData[k] > 0) rows += `<tr><td>${TIRE_LABELS[k]}</td><td>${w.tireData[k]} Stk</td><td>${w.prices[k]}</td><td>${(w.tireData[k]*w.prices[k]).toFixed(2)}</td></tr>`; });
    (w.partsList||[]).forEach(p => { if(p.p > 0) rows += `<tr><td>${p.t || 'Teil'}</td><td>1</td><td>${p.p}</td><td>${p.p.toFixed(2)}</td></tr>`; });

    const printHtml = `
        <div class="header-info"><strong>AutoLog</strong></div>
        <div class="address-client">
            ${cust.company ? cust.company + '<br>' : ''}
            ${cust.firstname} ${cust.lastname}<br>
            ${cust.street}<br>
            ${cust.zip} ${cust.city}
        </div>
        <div style="margin: 40px 10mm 20mm 10mm;">
            <h2 style="border-bottom: 2px solid #000; padding-bottom: 10px;">RECHNUNG</h2>
            <p>Datum: ${w.date} | KM-Stand: ${w.km}</p>
            <p><strong>Fahrzeug:</strong> ${v.brand} ${v.model} | <strong>Kennzeichen:</strong> ${v.plate} | <strong>VIN:</strong> ${v.vin || '-'}</p>
            <table class="inv-table">
                <thead><tr><th>Bezeichnung</th><th>Menge</th><th>Preis</th><th>Betrag</th></tr></thead>
                <tbody>${rows}</tbody>
                <tfoot><tr class="total-row"><td colspan="3" style="text-align:right">Gesamtbetrag CHF:</td><td>${calcTotal(w)}</td></tr></tfoot>
            </table>
        </div>
    `;

    document.getElementById("printArea").innerHTML = printHtml;
    window.print();
    
    // FEHLERBEHEBUNG: printArea nach dem Druckvorgang leeren, damit es nicht unten erscheint
    setTimeout(() => { document.getElementById("printArea").innerHTML = ""; }, 500);
}

// Hilfsfunktionen (identisch)
function toggleType(t,ci,vi,wi) { let c=get("customers",[]); let w=c[ci].vehicles[vi].works[wi]; w.types=w.types||[]; if(w.types.includes(t)) w.types=w.types.filter(x=>x!==t); else w.types.push(t); set("customers",c); openWork(ci,vi,wi); }
function updateW(ci,vi,wi) { let c=get("customers",[]); let w=c[ci].vehicles[vi].works[wi]; w.km=document.getElementById("wkm").value; set("customers",c); }
function calcTotal(w) {
    let t = 0; Object.keys(LABELS).forEach(k => t += (parseFloat(w.fluids[k])||0) * (w.prices[k]||0));
    (w.partsList||[]).forEach(p => t += (+p.p || 0));
    let h = (w.serviceFields?.inspection||0) + (w.serviceFields?.plugsT||0) + (w.serviceFields?.beltT||0) + (w.mfkPrepTime||0);
    (w.workList||[]).forEach(wk => h += (+wk.h || 0));
    t += (h * w.rate);
    Object.keys(TIRE_LABELS).forEach(k => t += ((w.tireData||{})[k] || 0) * (w.prices[k] || 0));
    return t.toFixed(2);
}
function renderDynamic(ci,vi,wi) {} // [Platzhalter f√ºr UI Felder]
function renderParts(ci,vi,wi) {
    let w = get("customers",[])[ci].vehicles[vi].works[wi]; let html = "";
    (w.partsList||[]).forEach((p,i) => html += `<div class="row-flex"><input placeholder="Teil" value="${p.t}" oninput="updatePart(${ci},${vi},${wi},${i},'t',this.value)"><input type="number" placeholder="CHF" value="${p.p}" oninput="updatePart(${ci},${vi},${wi},${i},'p',this.value)"></div>`);
    document.getElementById("partsContainer").innerHTML = html;
}
function addPartRow(ci,vi,wi) { let c=get("customers",[]); c[ci].vehicles[vi].works[wi].partsList.push({t:"",p:0}); set("customers",c); renderParts(ci,vi,wi); }
function updatePart(ci,vi,wi,i,k,v) { let c=get("customers",[]); c[ci].vehicles[vi].works[wi].partsList[i][k]=k==='p'?+v:v; set("customers",c); }
function exportData() { let a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([localStorage.getItem("customers")], {type: "application/json"})); a.download = "autolog_backup.json"; a.click(); }
startApp();
</script>
</body>
</html>
