<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .locked { border-left-color: var(--success); opacity: 0.9; }
        .check-group { background: #2c2c2e; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; margin: 8px 0; font-size: 16px; }
        .check-item input[type="checkbox"] { width: 25px; height: 25px; margin-right: 12px; }
        h3 { margin-top: 25px; color: var(--accent); }
        h4 { margin: 15px 0 5px 0; color: #eee; border-bottom: 1px solid #333; padding-bottom: 5px; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
        hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }
        @media print { body { background: white; color: black; } button, .btn-danger, hr, header { display: none !important; } .card { border: 1px solid #ccc; box-shadow: none; color: black; } }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");

// √úbersetzungshilfe f√ºr Keys
const LABELS = {
    oil: "Motor√∂l", coolant: "K√ºhlmittel", brake: "Bremsfl√ºssigkeit",
    gear: "Getriebe√∂l", servo: "Servolenkungs√∂l", washer: "Scheibenwischwasser"
};

const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function startApp() {
    let s = get("settings", { pinActive: true });
    if (s.pinActive) showPin(); else menu();
}

function showPin() {
    app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Werkstatt-Login</h3>
    <input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px">
    <button onclick="checkPin()">√ñffnen</button></div>`;
}
function checkPin() {
    if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN");
}

function menu() {
    app.innerHTML = `<button onclick="customers()">üë• Kundenverwaltung</button>
    <button onclick="settings()">‚öôÔ∏è Grundeinstellungen</button>
    <button class="btn-sec" onclick="exportData()">üíæ Daten-Backup</button>`;
}

/* SETTINGS */
function settings() {
    let s = get("settings", { pinActive: true, rate: 50, oil: 15, coolant: 10, brake: 20, gear: 25, servo: 18, washer: 2, cleanPrice: 20 });
    app.innerHTML = `<h3>Grundeinstellungen</h3>
    <small>Passwort-Schutz (PIN) beim Start</small>
    <select id="pinActive"><option value="true" ${s.pinActive?'selected':''}>Aktiviert</option><option value="false" ${!s.pinActive?'selected':''}>Deaktiviert</option></select>
    <hr>
    <small>Stundenansatz (CHF)</small><input id="rate" type="number" value="${s.rate}">
    <small>Preis Motor- & Karosseriereinigung (CHF)</small><input id="cleanPrice" type="number" value="${s.cleanPrice||20}">
    <h4>Preise pro Liter (CHF)</h4>
    ${Object.keys(LABELS).map(k => `<small>${LABELS[k]}</small><input id="${k}" type="number" value="${s[k]}">`).join('')}
    <button class="btn-save" onclick="saveSettings()">Speichern</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function saveSettings() {
    let newS = {
        pinActive: document.getElementById("pinActive").value === "true",
        rate: +document.getElementById("rate").value,
        cleanPrice: +document.getElementById("cleanPrice").value
    };
    Object.keys(LABELS).forEach(k => newS[k] = +document.getElementById(k).value);
    set("settings", newS);
    menu();
}

/* KUNDEN & FAHRZEUGE */
function customers() {
    let c = get("customers", []);
    let h = "<h3>Kunden</h3>";
    c.forEach((x, i) => h += `<div class="card"><strong>${x.name}</strong><button class="btn-sec" onclick="openCustomer(${i})">√ñffnen</button></div>`);
    app.innerHTML = h + `<button onclick="newCustomer()">+ Neuer Kunde</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}
function newCustomer() {
    app.innerHTML = `<h3>Neuer Kunde</h3><input id="cname" placeholder="Name"><button class="btn-save" onclick="saveCustomer()">Anlegen</button>`;
}
function saveCustomer() {
    let c = get("customers", []); c.push({name: document.getElementById("cname").value, vehicles: []});
    set("customers", c); customers();
}
function openCustomer(ci) {
    let cust = get("customers", [])[ci];
    let h = `<h3>Fahrzeuge: ${cust.name}</h3>`;
    cust.vehicles.forEach((v, vi) => h += `<div class="card"><strong>${v.brand} ${v.model}</strong><button onclick="works(${ci},${vi})">Rapporte</button></div>`);
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug</button><button class="btn-danger" onclick="deleteCustomer(${ci})">L√∂schen</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`;
}
function deleteCustomer(ci) { if(confirm("L√∂schen?")) { let c = get("customers", []); c.splice(ci,1); set("customers", c); customers(); } }
function newVehicle(ci) {
    app.innerHTML = `<h3>Neues Fahrzeug</h3><input id="vbrand" placeholder="Marke"><input id="vmodel" placeholder="Modell"><input id="vplate" placeholder="Kennzeichen"><button class="btn-save" onclick="saveVehicle(${ci})">Speichern</button>`;
}
function saveVehicle(ci) {
    let c = get("customers", []); c[ci].vehicles.push({ brand: document.getElementById("vbrand").value, model: document.getElementById("vmodel").value, plate: document.getElementById("vplate").value, works: [] });
    set("customers", c); openCustomer(ci);
}

/* RAPPORTE */
function works(ci, vi) {
    let v = get("customers", [])[ci].vehicles[vi];
    let h = `<h3>Rapporte: ${v.brand}</h3>`;
    v.works.forEach((w, wi) => h += `<div class="card ${w.closed?'locked':''}"><strong>${w.date} ‚Äì ${w.types?.join(', ') || 'Unbekannt'}</strong><button onclick="openWork(${ci},${vi},${wi})">Details</button></div>`);
    app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`;
}
function newWork(ci, vi) {
    let s = get("settings", {rate:50, cleanPrice:20}); let c = get("customers", []);
    c[ci].vehicles[vi].works.push({ 
        date: new Date().toLocaleDateString('de-CH'), km: "", 
        types: [], mfkPoints: {}, serviceFields: {inspection:0, oilFilter:0, pollenFilter:0},
        fluids: {}, note: "", time: 0, parts: 0, rate: s.rate, prices: {...s}, closed: false 
    });
    set("customers", c); openWork(ci, vi, c[ci].vehicles[vi].works.length - 1);
}

function openWork(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    let dis = w.closed ? "disabled" : "";
    
    app.innerHTML = `<h3>Rapport ‚Äì ${w.date}</h3>
    <small>Arbeitsart (Mehrfachauswahl)</small>
    <div class="check-group">
        ${["Service","MFK","Fl√ºssigkeiten","Reifenwechsel","Reparatur"].map(t => `
            <label class="check-item"><input ${dis} type="checkbox" onchange="toggleType('${t}', ${ci}, ${vi}, ${wi})" ${w.types?.includes(t)?'checked':''}> ${t}</label>
        `).join('')}
    </div>

    <small>KM-Stand</small><input ${dis} id="wkm" type="number" value="${w.km}" oninput="updateW(${ci},${vi},${wi})">

    <div id="dynamicFields"></div>

    <div id="fluidSection"></div>
    
    <h4>Zus√§tzliche Kosten</h4>
    <small>Manuelle Arbeitszeit (Std)</small><input ${dis} id="wtime" type="number" step="0.1" value="${w.time}" oninput="updateW(${ci},${vi},${wi})">
    <small>Sonstige Teile (CHF)</small><input ${dis} id="wparts" type="number" value="${w.parts}" oninput="updateW(${ci},${vi},${wi})">
    
    <textarea ${dis} id="wnote" placeholder="Bemerkungen" oninput="updateW(${ci},${vi},${wi})">${w.note}</textarea>
    <hr><div style="font-size:24px; font-weight:bold" id="liveTotal">Total: CHF ${calcTotal(w)}</div>
    
    ${!w.closed ? `
        <button onclick="saveW(${ci},${vi},${wi}, false)">üíæ Speichern</button>
        <button class="btn-save" onclick="saveW(${ci},${vi},${wi}, true)">‚úÖ Abschliessen</button>
    ` : ''}
    <button class="btn-sec" onclick="window.print()">üñ®Ô∏è Drucken</button><button class="btn-sec" onclick="works(${ci},${vi})">Zur√ºck</button>`;
    
    renderDynamic(ci, vi, wi);
}

function toggleType(type, ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    if(!w.types) w.types = [];
    if(w.types.includes(type)) w.types = w.types.filter(t => t !== type);
    else w.types.push(type);
    set("customers", c);
    renderDynamic(ci, vi, wi);
    updateW(ci, vi, wi);
}

function renderDynamic(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    let dis = w.closed ? "disabled" : "";
    
    // Dynamic Fields (Service / MFK)
    let dHtml = "";
    if(w.types?.includes("Service")) {
        dHtml += `<h4>Service Details</h4>
        <small>Jahres Inspektion (Std)</small><input ${dis} type="number" step="0.1" id="s_insp" value="${w.serviceFields?.inspection||0}" oninput="updateW(${ci},${vi},${wi})">
        <small>√ñlfilter (CHF)</small><input ${dis} type="number" id="s_oilf" value="${w.serviceFields?.oilFilter||0}" oninput="updateW(${ci},${vi},${wi})">
        <small>Pollenfilter (CHF)</small><input ${dis} type="number" id="s_poll" value="${w.serviceFields?.pollenFilter||0}" oninput="updateW(${ci},${vi},${wi})">`;
    }
    if(w.types?.includes("MFK")) {
        dHtml += `<h4>MFK Checkliste</h4>
        <small>MFK richten (Std)</small><input ${dis} type="number" step="0.1" id="m_prep" value="${w.mfkPrepTime||0}" oninput="updateW(${ci},${vi},${wi})">
        <div class="check-group">
            ${["Licht gepr√ºft","Licht eingestellt","Leuchtweitenregulierung","Bremsen gepr√ºft","Horn gepr√ºft","Lenkradsperre","Scheibenwischer","Auspuff gepr√ºft","Reifen gepr√ºft","Frontscheibe & Beleuchtung","Motor & Karosserie gereinigt"].map(p => `
                <label class="check-item"><input ${dis} type="checkbox" onchange="toggleMfk('${p}', ${ci}, ${vi}, ${wi})" ${w.mfkPoints?.[p]?'checked':''}> ${p}</label>
            `).join('')}
        </div>`;
    }
    document.getElementById("dynamicFields").innerHTML = dHtml;

    // Fluid Section (Nur wenn Service oder Fl√ºssigkeiten)
    let fHtml = "";
    if(w.types?.includes("Service") || w.types?.includes("Fl√ºssigkeiten")) {
        fHtml = `<h4>Fl√ºssigkeiten (Liter)</h4>` + Object.keys(LABELS).map(k => `<small>${LABELS[k]}</small><input ${dis} id="f_${k}" type="number" step="0.1" value="${w.fluids[k]||0}" oninput="updateW(${ci},${vi},${wi})">`).join('');
    }
    document.getElementById("fluidSection").innerHTML = fHtml;
}

function toggleMfk(point, ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    if(!w.mfkPoints) w.mfkPoints = {};
    w.mfkPoints[point] = !w.mfkPoints[point];
    set("customers", c);
    updateW(ci, vi, wi);
}

function updateW(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    w.km = document.getElementById("wkm").value;
    w.time = +document.getElementById("wtime").value;
    w.parts = +document.getElementById("wparts").value;
    w.note = document.getElementById("wnote").value;
    
    // Fl√ºssigkeiten nur speichern wenn Felder existieren
    Object.keys(LABELS).forEach(k => {
        let el = document.getElementById("f_"+k);
        if(el) w.fluids[k] = el.value;
    });
    
    if(w.types?.includes("Service")) {
        w.serviceFields = {
            inspection: +document.getElementById("s_insp").value,
            oilFilter: +document.getElementById("s_oilf").value,
            pollenFilter: +document.getElementById("s_poll").value
        };
    }
    if(w.types?.includes("MFK")) {
        w.mfkPrepTime = +document.getElementById("m_prep").value;
    }
    document.getElementById("liveTotal").innerText = "Total: CHF " + calcTotal(w);
    set("customers", c);
}

function calcTotal(w) {
    let fT = 0; 
    Object.keys(LABELS).forEach(k => fT += (parseFloat(w.fluids[k])||0) * (w.prices[k]||0));
    
    let serviceExtra = (w.serviceFields?.inspection || 0) * w.rate + (w.serviceFields?.oilFilter || 0) + (w.serviceFields?.pollenFilter || 0);
    let mfkExtra = (w.mfkPrepTime || 0) * w.rate;
    
    // Reinigungspreis
    let cleanExtra = (w.mfkPoints?.["Motor & Karosserie gereinigt"]) ? (w.prices.cleanPrice || 20) : 0;
    
    return ( (w.time * w.rate) + fT + (+w.parts || 0) + serviceExtra + mfkExtra + cleanExtra ).toFixed(2);
}

function saveW(ci, vi, wi, close) {
    if(close && !confirm("Abschliessen?")) return;
    updateW(ci, vi, wi);
    if(close) {
        let c = get("customers", []); c[ci].vehicles[vi].works[wi].closed = true;
        set("customers", c); works(ci, vi);
    } else alert("Gespeichert");
}

function exportData() {
    let a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([localStorage.getItem("customers")], {type: "application/json"}));
    a.download = "backup.json"; a.click();
}

startApp();
</script>
</body>
</html>
