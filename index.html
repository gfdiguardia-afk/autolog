<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
            --work-btn: #5856d6;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-work { background: var(--work-btn); }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .check-group { background: #2c2c2e; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 12px; margin: 12px 0; font-size: 16px; }
        .row-flex { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; width: 100%; }
        .price-tag { color: var(--success); font-weight: bold; font-size: 14px; margin-left: auto; }
        h3 { margin-top: 25px; color: var(--accent); }
        h4 { margin: 15px 0 5px 0; color: #eee; border-bottom: 1px solid #333; padding-bottom: 5px; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
        hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }
        .btn-minus { width: 44px; height: 44px; padding: 0; flex-shrink: 0; margin: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; background: var(--danger); }
    </style>
</head>
<body>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");
const LABELS = { oil: "Motor√∂l", washer: "Scheibenwischwasser", coolant: "K√ºhlmittel", brake: "Bremsfl√ºssigkeit", gear: "Getriebe√∂l", servo: "Servolenkungs√∂l" };
const TIRE_LABELS = { t_mont: "Reifen montieren", t_vent: "Ventil", t_alu: "Auswuchten Alu", t_met: "Auswuchten Metall", t_clean: "Reinigen", t_store: "Lagern", t_repair: "Reifen repariert" };

const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function startApp() { let s = get("settings", { pinActive: true }); if (s.pinActive) showPin(); else menu(); }
function showPin() { app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Werkstatt-Login</h3><input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px"><button onclick="checkPin()">√ñffnen</button></div>`; }
function checkPin() { if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); }
function menu() { app.innerHTML = `<button onclick="customers()">üë• Kundenverwaltung</button><button onclick="settings()">‚öôÔ∏è Grundeinstellungen</button><button class="btn-sec" onclick="exportData()">üíæ Daten-Backup</button>`; }

function settings() {
    let s = get("settings", { pinActive: true, rate: 50, oil: 15, coolant: 10, brake: 20, gear: 25, servo: 18, washer: 2, cleanPrice: 20, t_mont: 20, t_vent: 5, t_alu: 15, t_met: 10, t_clean: 10, t_store: 40, t_repair: 15 });
    app.innerHTML = `<h3>Grundeinstellungen</h3><small>PIN-Schutz</small><select id="pinActive"><option value="true" ${s.pinActive?'selected':''}>Aktiv</option><option value="false" ${!s.pinActive?'selected':''}>Aus</option></select>
    <small>Stundenansatz (CHF)</small><input id="rate" type="number" placeholder="CHF" value="${s.rate||''}">
    <button class="btn-save" onclick="saveSettings()">Speichern</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}

function saveSettings() {
    let newS = { pinActive: document.getElementById("pinActive").value === "true", rate: +document.getElementById("rate").value };
    set("settings", newS); menu();
}

function customers() { 
    let c = get("customers", []); 
    let h = `<h3>Kunden</h3><input type="text" id="liveSearch" placeholder="Suchen..." oninput="performSearch()"><div id="customerResults">`;
    c.forEach((x, i) => h += `<div class="card search-item" data-info="${(x.name).toLowerCase()}"><strong>${x.name}</strong><button class="btn-sec" onclick="openCustomer(${i})">√ñffnen</button></div>`);
    app.innerHTML = h + `</div><button onclick="newCustomer()">+ Neuer Kunde</button><button class="btn-sec" onclick="menu()">Zur√ºck</button>`; 
}

function performSearch() {
    let query = document.getElementById("liveSearch").value.toLowerCase();
    document.querySelectorAll(".search-item").forEach(item => item.style.display = item.getAttribute("data-info").includes(query) ? "block" : "none");
}

function newCustomer() { app.innerHTML = `<h3>Neuer Kunde</h3><input id="cname" placeholder="Name"><button class="btn-save" onclick="saveCustomer()">Anlegen</button>`; }
function saveCustomer() { let c = get("customers", []); c.push({name: document.getElementById("cname").value, vehicles: []}); set("customers", c); customers(); }
function openCustomer(ci) { 
    let cust = get("customers", [])[ci]; 
    let h = `<h3>Fahrzeuge: ${cust.name}</h3>`; 
    cust.vehicles.forEach((v, vi) => h += `<div class="card"><strong>${v.brand} ${v.model}</strong><button onclick="works(${ci},${vi})">Rapporte</button></div>`); 
    app.innerHTML = h + `<button onclick="newVehicle(${ci})">+ Fahrzeug</button><button class="btn-sec" onclick="customers()">Zur√ºck</button>`; 
}

function newVehicle(ci) { app.innerHTML = `<h3>Neues Fahrzeug</h3><input id="vbrand" placeholder="Marke"><input id="vmodel" placeholder="Modell"><button class="btn-save" onclick="saveVehicle(${ci})">Speichern</button>`; }
function saveVehicle(ci) { let c = get("customers", []); c[ci].vehicles.push({ brand: document.getElementById("vbrand").value, model: document.getElementById("vmodel").value, works: [] }); set("customers", c); openCustomer(ci); }

function works(ci, vi) { let v = get("customers", [])[ci].vehicles[vi]; let h = `<h3>Rapporte</h3>`; v.works.forEach((w, wi) => h += `<div class="card"><strong>${w.date}</strong><button onclick="openWork(${ci},${vi},${wi})">Ansehen</button></div>`); app.innerHTML = h + `<button onclick="newWork(${ci},${vi})">+ Neuer Rapport</button><button class="btn-sec" onclick="openCustomer(${ci})">Zur√ºck</button>`; }

function newWork(ci, vi) { 
    let s = get("settings", {rate:50}); let c = get("customers", []); 
    c[ci].vehicles[vi].works.push({ date: new Date().toLocaleDateString('de-CH'), km: "", types: [], fluids: {}, partsList: [], workList: [], rate: s.rate, prices: {...s}, closed: false }); 
    set("customers", c); openWork(ci, vi, c[ci].vehicles[vi].works.length - 1); 
}

function openWork(ci, vi, wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    if(!w.partsList) w.partsList = []; if(!w.workList) w.workList = [];
    let dis = w.closed ? "disabled" : "";
    app.innerHTML = `<h3>Rapport ‚Äì ${w.date}</h3>
    <small>Arbeitsart</small>
    <div class="check-group">
        ${["Service","Fl√ºssigkeiten","Reparatur"].map(t => `<label class="check-item"><input ${dis} type="checkbox" onchange="toggleType('${t}',${ci},${vi},${wi})" ${w.types?.includes(t)?'checked':''}> <span>${t}</span></label>`).join('')}
    </div>
    <small>KM-Stand</small><input ${dis} id="wkm" type="number" value="${w.km}" oninput="updateW(${ci},${vi},${wi})">
    
    <div id="repairSection" style="display:${w.types?.includes('Reparatur')?'block':'none'}">
        <h4>Sonstige Teile / Arbeit</h4>
        <div id="dynamicContainer"></div>
        <div class="row-flex">
            <button ${dis} class="btn-save" onclick="addPartRow(${ci},${vi},${wi})">+ Teile</button>
            <button ${dis} class="btn-work" onclick="addWorkRow(${ci},${vi},${wi})">+ Arbeit</button>
        </div>
    </div>

    <textarea ${dis} id="wnote" placeholder="Bemerkungen" oninput="updateW(${ci},${vi},${wi})">${w.note||''}</textarea>
    <hr><div style="font-size:24px; font-weight:bold; color:var(--success)" id="liveTotal">Total: CHF ${calcTotal(w)}</div>
    ${!w.closed ? `<button class="btn-save" onclick="saveW(${ci},${vi},${wi}, true)">‚úÖ Abschliessen</button>` : ''}
    <button class="btn-sec" onclick="works(${ci},${vi})">Zur√ºck</button>`;
    renderDynamicRows(ci, vi, wi);
}

function renderDynamicRows(ci, vi, wi) {
    let w = get("customers", [])[ci].vehicles[vi].works[wi];
    let dis = w.closed ? "disabled" : "";
    let html = "";
    (w.partsList || []).forEach((p, i) => {
        html += `<div class="row-flex">
            <input ${dis} placeholder="Teil Bezeichnung" value="${p.t}" oninput="updateRowItem(${ci},${vi},${wi},${i},'t',this.value,'parts')">
            <input ${dis} type="number" placeholder="CHF" style="width:100px" value="${p.p||''}" oninput="updateRowItem(${ci},${vi},${wi},${i},'p',this.value,'parts')">
            <button ${dis} class="btn-minus" onclick="removeRow(${ci},${vi},${wi},${i},'parts')">-</button>
        </div>`;
    });
    (w.workList || []).forEach((wk, i) => {
        html += `<div class="row-flex">
            <input ${dis} placeholder="Arbeit Bezeichnung" value="${wk.t}" oninput="updateRowItem(${ci},${vi},${wi},${i},'t',this.value,'work')">
            <input ${dis} type="number" step="0.1" placeholder="Std" style="width:100px" value="${wk.h||''}" oninput="updateRowItem(${ci},${vi},${wi},${i},'h',this.value,'work')">
            <button ${dis} class="btn-minus" onclick="removeRow(${ci},${vi},${wi},${i},'work')">-</button>
        </div>`;
    });
    document.getElementById("dynamicContainer").innerHTML = html;
}

function addPartRow(ci, vi, wi) { let c = get("customers", []); if(!c[ci].vehicles[vi].works[wi].partsList) c[ci].vehicles[vi].works[wi].partsList = []; c[ci].vehicles[vi].works[wi].partsList.push({t:"",p:0}); set("customers", c); renderDynamicRows(ci, vi, wi); }
function addWorkRow(ci, vi, wi) { let c = get("customers", []); if(!c[ci].vehicles[vi].works[wi].workList) c[ci].vehicles[vi].works[wi].workList = []; c[ci].vehicles[vi].works[wi].workList.push({t:"",h:0}); set("customers", c); renderDynamicRows(ci, vi, wi); }

function removeRow(ci, vi, wi, i, type) { 
    let c = get("customers", []); 
    if(type==='parts') c[ci].vehicles[vi].works[wi].partsList.splice(i, 1);
    else c[ci].vehicles[vi].works[wi].workList.splice(i, 1);
    set("customers", c); renderDynamicRows(ci, vi, wi); updateW(ci, vi, wi); 
}

function updateRowItem(ci, vi, wi, i, k, v, type) {
    let c = get("customers", []);
    if(type==='parts') c[ci].vehicles[vi].works[wi].partsList[i][k] = k==='p'?+v:v;
    else c[ci].vehicles[vi].works[wi].workList[i][k] = k==='h'?+v:v;
    set("customers", c); updateW(ci, vi, wi);
}

function toggleType(t,ci,vi,wi) { 
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi]; 
    w.types=w.types||[]; if(w.types.includes(t)) w.types=w.types.filter(x=>x!==t); else w.types.push(t); 
    set("customers", c); openWork(ci, vi, wi);
}

function updateW(ci,vi,wi) {
    let c = get("customers", []); let w = c[ci].vehicles[vi].works[wi];
    w.km = document.getElementById("wkm").value; w.note = document.getElementById("wnote").value;
    document.getElementById("liveTotal").innerText = "Total: CHF " + calcTotal(w); set("customers", c);
}

function calcTotal(w) {
    let pT = (w.partsList || []).reduce((sum, p) => sum + (+p.p || 0), 0);
    let wT = (w.workList || []).reduce((sum, wk) => sum + ((+wk.h || 0) * (w.rate || 50)), 0);
    return (pT + wT).toFixed(2);
}

function saveW(ci, vi, wi, close) {
    updateW(ci, vi, wi);
    if(close) { let c = get("customers", []); c[ci].vehicles[vi].works[wi].closed = true; set("customers", c); works(ci, vi); }
}

function exportData() { let a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([localStorage.getItem("customers")], {type: "application/json"})); a.download = "backup.json"; a.click(); }
startApp();
</script>
</body>
</html>
