<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoLog Pro OCR</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #007aff;
            --danger: #ff3b30; --success: #34c759; --text: #ffffff; --text-dim: #b0b0b0;
            --work-btn: #5856d6;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        button { width: 100%; margin: 8px 0; padding: 14px; border: none; border-radius: 10px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-sec { background: #333; } .btn-danger { background: var(--danger); } .btn-save { background: var(--success); }
        .btn-ocr { background: #ff9500; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 16px; }
        .card { background: var(--card); padding: 16px; margin: 12px 0; border-radius: 12px; border-left: 4px solid var(--accent); }
        .row-flex { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; width: 100%; }
        small { display: block; margin-top: 4px; color: var(--text-dim); font-size: 12px; }
        .img-preview { width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #333; }
        #loadingOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center; flex-direction:column; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <p>Analysiere Ausweis...</p>
</div>

<header>AutoLog Pro</header>
<div class="container" id="app"></div>

<script>
const PIN = "1234";
const app = document.getElementById("app");
const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } };
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

// --- OCR LOGIK ---
async function handleScan(targetType, ci = null) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        try {
            const base64Image = await resizeImage(file);
            const apiKey = get("settings", {}).googleApiKey;
            
            if (!apiKey) {
                alert("Bitte Google API Key in den Einstellungen hinterlegen!");
                document.getElementById('loadingOverlay').style.display = 'none';
                return;
            }

            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                method: 'POST',
                body: JSON.stringify({
                    requests: [{
                        image: { content: base64Image.split(',')[1] },
                        features: [{ type: 'TEXT_DETECTION' }]
                    }]
                })
            });

            const data = await response.json();
            const text = data.responses[0].fullTextAnnotation.text;
            const parsed = parseSwissID(text);
            
            if (targetType === 'customer') {
                showNewCustomerForm(parsed, base64Image);
            } else {
                showNewVehicleForm(ci, parsed, base64Image);
            }
        } catch (err) {
            alert("Fehler beim Scan: " + err);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    };
    input.click();
}

function resizeImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000;
                let width = img.width;
                let height = img.height;
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

function parseSwissID(text) {
    // Einfache Regex-Suche basierend auf den typischen Schweizer Positionen
    const lines = text.split('\n');
    const result = {
        name: "", address: "", zip: "", city: "", dob: "",
        plate: "", brand: "", model: "", vin: "", capacity: "", power: "", weight: "", body: "", mfk: ""
    };

    // Kennzeichen (Pos 15)
    const plateMatch = text.match(/[A-Z]{2}\s\d{2,}\s?\d*/);
    if (plateMatch) result.plate = plateMatch[0];

    // VIN (Pos 23)
    const vinMatch = text.match(/[A-Z0-9]{17}/);
    if (vinMatch) result.vin = vinMatch[0];

    // Hubraum (Pos 37) & Leistung (Pos 76) & Gewicht (Pos 30)
    lines.forEach(line => {
        if (line.includes('AUDI') || line.includes('BMW') || line.includes('VW')) result.brand = line;
        if (line.match(/^\d{4}$/) && !result.capacity) result.capacity = line; // 37
        if (line.match(/^\d{2,3}$/) && line.length < 4) result.power = line; // 76
        if (line.includes('Limousine') || line.includes('Kombi')) result.body = line;
    });

    return result;
}

// --- APP VIEWS ---
function startApp() { let s = get("settings", { pinActive: true }); if (s.pinActive) showPin(); else menu(); }
function showPin() { app.innerHTML = `<div style="text-align:center; padding-top:50px"><h3>Werkstatt-Login</h3><input id="pinInput" type="password" placeholder="PIN" style="text-align:center; font-size:24px"><button onclick="checkPin()">√ñffnen</button></div>`; }
function checkPin() { if(document.getElementById("pinInput").value === PIN) menu(); else alert("Falscher PIN"); }

function menu() { 
    app.innerHTML = `
        <button onclick="customers()">üë• Kundenverwaltung</button>
        <button onclick="settings()">‚öôÔ∏è Grundeinstellungen</button>
        <button class="btn-sec" onclick="exportData()">üíæ Daten-Backup</button>`; 
}

function settings() {
    let s = get("settings", { googleApiKey: "" });
    app.innerHTML = `
        <h3>Einstellungen</h3>
        <small>Google Cloud Vision API Key</small>
        <input id="apiKey" type="password" value="${s.googleApiKey}" placeholder="AI Key hier einf√ºgen">
        <button class="btn-save" onclick="saveSettings()">Speichern</button>
        <button class="btn-sec" onclick="menu()">Zur√ºck</button>`;
}

function saveSettings() {
    let s = get("settings", {});
    s.googleApiKey = document.getElementById("apiKey").value;
    set("settings", s); menu();
}

function customers() { 
    let c = get("customers", []); 
    let h = `<h3>Kunden</h3><input type="text" id="liveSearch" placeholder="Suche..." oninput="performSearch()"><div id="customerResults">`;
    c.forEach((x, i) => {
        h += `<div class="card search-item" data-info="${x.name.toLowerCase()}">
                <strong>${x.name}</strong>
                <button class="btn-sec" onclick="openCustomer(${i})">√ñffnen</button>
              </div>`;
    });
    app.innerHTML = h + `</div>
        <button class="btn-ocr" onclick="handleScan('customer')">üì∑ Neuer Kunde (Scan)</button>
        <button onclick="showNewCustomerForm()">+ Manueller Kunde</button>
        <button class="btn-sec" onclick="menu()">Zur√ºck</button>`; 
}

function showNewCustomerForm(data = {}, img = null) {
    app.innerHTML = `
        <h3>Kunden-Stammdaten</h3>
        <input id="cname" placeholder="Name, Vorname" value="${data.name || ''}">
        <input id="caddr" placeholder="Strasse" value="${data.address || ''}">
        <div class="row-flex">
            <input id="czip" placeholder="PLZ" value="${data.zip || ''}">
            <input id="ccity" placeholder="Ort" value="${data.city || ''}">
        </div>
        <small>Geburtsdatum</small>
        <input id="cdob" type="date" value="${data.dob || ''}">
        <hr>
        <h4>Erstes Fahrzeug</h4>
        <input id="vbrand" placeholder="Marke" value="${data.brand || ''}">
        <input id="vplate" placeholder="Kennzeichen" value="${data.plate || ''}">
        <input id="vvin" placeholder="VIN (Fahrgestell-Nr)" value="${data.vin || ''}">
        <button class="btn-save" onclick="saveCustomerWithVehicle('${img || ''}')">Speichern</button>
        <button class="btn-sec" onclick="customers()">Abbrechen</button>`;
}

function saveCustomerWithVehicle(img) {
    let c = get("customers", []);
    let name = document.getElementById("cname").value;
    if(!name) return alert("Name fehlt");
    
    let newCust = {
        name: name,
        address: document.getElementById("caddr").value,
        zip: document.getElementById("czip").value,
        city: document.getElementById("ccity").value,
        dob: document.getElementById("cdob").value,
        vehicles: [{
            brand: document.getElementById("vbrand").value,
            plate: document.getElementById("vplate").value.toUpperCase(),
            vin: document.getElementById("vvin").value,
            idCardImg: img,
            works: []
        }]
    };
    c.push(newCust);
    set("customers", c);
    customers();
}

function openCustomer(ci) { 
    let cust = get("customers", [])[ci]; 
    let h = `<h3>${cust.name}</h3><small>${cust.address}, ${cust.zip} ${cust.city}</small><hr>`; 
    cust.vehicles.forEach((v, vi) => {
        h += `<div class="card">
                <div class="clickable-header" onclick="editVehicle(${ci},${vi})">
                    <strong>${v.brand}</strong> - ${v.plate || '---'}
                </div>
                ${v.idCardImg ? `<img src="${v.idCardImg}" class="img-preview" onclick="showBigImg('${v.idCardImg}')">` : ''}
                <button onclick="works(${ci},${vi})">Rapporte</button>
              </div>`;
    }); 
    app.innerHTML = h + `
        <button class="btn-ocr" onclick="handleScan('vehicle', ${ci})">üì∑ Fahrzeug scannen</button>
        <button onclick="showNewVehicleForm(${ci})">+ Fahrzeug manuell</button>
        <button class="btn-sec" onclick="customers()">Zur√ºck</button>`; 
}

function showNewVehicleForm(ci, data = {}, img = null) {
    app.innerHTML = `
        <h3>Fahrzeug-Details</h3>
        <input id="vbrand" placeholder="Marke / Modell" value="${data.brand || ''}">
        <input id="vplate" placeholder="Kennzeichen" value="${data.plate || ''}">
        <input id="vvin" placeholder="VIN" value="${data.vin || ''}">
        <div class="row-flex">
            <input id="vcap" placeholder="Hubraum cm3" value="${data.capacity || ''}">
            <input id="vpow" placeholder="Leistung kW" value="${data.power || ''}">
        </div>
        <div class="row-flex">
            <input id="vweight" placeholder="Leergewicht kg" value="${data.weight || ''}">
            <input id="vbody" placeholder="Karosserie" value="${data.body || ''}">
        </div>
        <small>Letzte Pr√ºfung (MFK)</small>
        <input id="vmfk" type="text" placeholder="TT.MM.JJJJ" value="${data.mfk || ''}">
        <button class="btn-save" onclick="saveVehicle(${ci}, '${img || ''}')">Speichern</button>
        <button class="btn-sec" onclick="openCustomer(${ci})">Abbrechen</button>`;
}

function saveVehicle(ci, img) {
    let c = get("customers", []);
    c[ci].vehicles.push({
        brand: document.getElementById("vbrand").value,
        plate: document.getElementById("vplate").value.toUpperCase(),
        vin: document.getElementById("vvin").value,
        capacity: document.getElementById("vcap").value,
        power: document.getElementById("vpow").value,
        weight: document.getElementById("vweight").value,
        body: document.getElementById("vbody").value,
        mfkDate: document.getElementById("vmfk").value,
        idCardImg: img,
        works: []
    });
    set("customers", c);
    openCustomer(ci);
}

function showBigImg(src) {
    const win = window.open("");
    win.document.write(`<img src="${src}" style="width:100%">`);
}

// (Hier folgen die restlichen Funktionen wie performSearch, works, etc. aus dem Original-Code...)
function performSearch() {
    let q = document.getElementById("liveSearch").value.toLowerCase();
    document.querySelectorAll(".search-item").forEach(i => i.style.display = i.dataset.info.includes(q) ? "block" : "none");
}

startApp();
</script>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</body>
</html>
